dojo._hasResource["dojo.data.ItemFileWriteStore"]||(dojo._hasResource["dojo.data.ItemFileWriteStore"]=!0,dojo.provide("dojo.data.ItemFileWriteStore"),dojo.require("dojo.data.ItemFileReadStore"),dojo.declare("dojo.data.ItemFileWriteStore",dojo.data.ItemFileReadStore,{constructor:function(){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return dojo.date.stamp.toISOString(e,{zulu:!0})}),this._saveInProgress=!1},_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){var e=this.getFeatures()["dojo.data.api.Identity"];return e},newItem:function(e,t){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof e&&"undefined"!=typeof e)throw new Error("newItem() was passed something other than an object");var i=null,s=this._getIdentifierAttribute();if(s===Number)i=this._arrayOfAllItems.length;else{if(i=e[s],"undefined"==typeof i)throw new Error("newItem() was not passed an identity for the new item");if(dojo.isArray(i))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert("undefined"==typeof this._itemsByIdentity[i]),this._assert("undefined"==typeof this._pending._newItems[i]),this._assert("undefined"==typeof this._pending._deletedItems[i]);var r={};r[this._storeRefPropName]=this,r[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[i]=r),this._arrayOfAllItems.push(r);var n=null;if(t&&t.parent&&t.attribute){n={item:t.parent,attribute:t.attribute,oldValue:void 0};var a=this.getValues(t.parent,t.attribute);if(a&&a.length>0){var o=a.slice(0,a.length);n.oldValue=1===a.length?a[0]:a.slice(0,a.length),o.push(r),this._setValueOrValues(t.parent,t.attribute,o,!1),n.newValue=this.getValues(t.parent,t.attribute)}else this._setValueOrValues(t.parent,t.attribute,r,!1),n.newValue=r}else r[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(r);this._pending._newItems[i]=r;for(var h in e){if(h===this._storeRefPropName||h===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var l=e[h];dojo.isArray(l)||(l=[l]),r[h]=l}return this.onNew(r,n),r},_removeArrayElement:function(e,t){var i=dojo.indexOf(e,t);return-1!=i?(e.splice(i,1),!0):!1},deleteItem:function(e){this._assert(!this._saveInProgress),this._assertIsItem(e);var t=e[this._itemNumPropName];this._arrayOfAllItems[t]=null;var i=this.getIdentity(e);return e[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[i],this._pending._deletedItems[i]=e,e[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,e),this.onDelete(e),!0},setValue:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},setValues:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},unsetAttribute:function(e,t){return this._setValueOrValues(e,t,[],!0)},_setValueOrValues:function(e,t,i,s){this._assert(!this._saveInProgress),this._assertIsItem(e),this._assert(dojo.isString(t)),this._assert("undefined"!=typeof i);var r=this._getIdentifierAttribute();if(t==r)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var n=this._getValueOrValues(e,t),a=this.getIdentity(e);if(!this._pending._modifiedItems[a]){var o={};for(var h in e)if(h===this._storeRefPropName||h===this._itemNumPropName||h===this._rootItemPropName)o[h]=e[h];else{for(var l=e[h],_=[],d=0;d<l.length;++d)_.push(l[d]);o[h]=_}this._pending._modifiedItems[a]=o}var m=!1;if(dojo.isArray(i)&&0===i.length)m=delete e[t],i=void 0;else{var u=[];if(dojo.isArray(i))for(var f=i,p=0;p<f.length;++p)u.push(f[p]);else{var I=i;u.push(I)}e[t]=u,m=!0}return s&&this.onSet(e,t,n,i),m},_getValueOrValues:function(e,t){var i=void 0;if(this.hasAttribute(e,t)){var s=this.getValues(e,t);i=1==s.length?s[0]:s}return i},_flatten:function(e){if(this.isItem(e)){var t=e,i=this.getIdentity(t),s={_reference:i};return s}if("object"==typeof e)for(type in this._datatypeMap){var r=this._datatypeMap[type];if(dojo.isObject(r)&&!dojo.isFunction(r)){if(e instanceof r.type){if(!r.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+type+"]");return{_type:type,_value:r.serialize(e)}}}else if(e instanceof r)return{_type:type,_value:e.toString()}}return e},_getNewFileContentString:function(){var e={},t=this._getIdentifierAttribute();t!==Number&&(e.identifier=t),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var i=0;i<this._arrayOfAllItems.length;++i){var s=this._arrayOfAllItems[i];if(null!==s){serializableItem={};for(var r in s)if(r!==this._storeRefPropName&&r!==this._itemNumPropName){var n=r,a=this.getValues(s,n);if(1==a.length)serializableItem[n]=this._flatten(a[0]);else for(var o=[],h=0;h<a.length;++h)o.push(this._flatten(a[h])),serializableItem[n]=o}e.items.push(serializableItem)}}var l=!0;return dojo.toJson(e,l)},save:function(e){this._assert(!this._saveInProgress),this._saveInProgress=!0;var t=this,i=function(){if(t._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},t._saveInProgress=!1,e&&e.onComplete){var i=e.scope||dojo.global;e.onComplete.call(i)}},s=function(){if(t._saveInProgress=!1,e&&e.onError){var i=e.scope||dojo.global;e.onError.call(i)}};if(this._saveEverything){var r=this._getNewFileContentString();this._saveEverything(i,s,r)}this._saveCustom&&this._saveCustom(i,s),this._saveEverything||this._saveCustom||i()},revert:function(){this._assert(!this._saveInProgress);var e;for(e in this._pending._newItems){var t=this._pending._newItems[e];t[this._storeRefPropName]=null,this._arrayOfAllItems[t[this._itemNumPropName]]=null,t[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,t),this._itemsByIdentity&&delete this._itemsByIdentity[e]}for(e in this._pending._modifiedItems){var i=this._pending._modifiedItems[e],s=null;s=this._itemsByIdentity?this._itemsByIdentity[e]:this._arrayOfAllItems[e],i[this._storeRefPropName]=this,s[this._storeRefPropName]=null;var r=s[this._itemNumPropName];this._arrayOfAllItems[r]=i,s[this._rootItemPropName]&&(r=s[this._itemNumPropName],this._arrayOfTopLevelItems[r]=i),this._itemsByIdentity&&(this._itemsByIdentity[e]=i)}for(e in this._pending._deletedItems){var n=this._pending._deletedItems[e];n[this._storeRefPropName]=this;var a=n[this._itemNumPropName];this._arrayOfAllItems[a]=n,this._itemsByIdentity&&(this._itemsByIdentity[e]=n),n[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(n)}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var t=this.getIdentity(e);return new Boolean(this._pending._newItems[t]||this._pending._modifiedItems[t]||this._pending._deletedItems[t])}var i;for(i in this._pending._newItems)return!0;for(i in this._pending._modifiedItems)return!0;for(i in this._pending._deletedItems)return!0;return!1},onSet:function(){},onNew:function(){},onDelete:function(){}}));