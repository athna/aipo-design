dojo._hasResource["dojo.dnd.Manager"]||(dojo._hasResource["dojo.dnd.Manager"]=!0,dojo.provide("dojo.dnd.Manager"),dojo.require("dojo.dnd.common"),dojo.require("dojo.dnd.autoscroll"),dojo.require("dojo.dnd.Avatar"),dojo.dnd.Manager=function(){this.avatar=null,this.source=null,this.nodes=[],this.copy=!0,this.target=null,this.canDropFlag=!1,this.events=[]},dojo.extend(dojo.dnd.Manager,{OFFSET_X:16,OFFSET_Y:16,overSource:function(o){this.avatar&&(this.target=o&&"Disabled"!=o.targetState?o:null,this.avatar.update()),dojo.publish("/dnd/source/over",[o])},outSource:function(o){this.avatar?this.target==o&&(this.target=null,this.canDropFlag=!1,this.avatar.update(),dojo.publish("/dnd/source/over",[null])):dojo.publish("/dnd/source/over",[null])},startDrag:function(o,t,a){this.source=o,this.nodes=t,this.copy=Boolean(a),this.avatar=this.makeAvatar(),dojo.body().appendChild(this.avatar.node),dojo.publish("/dnd/start",[o,t,this.copy]),this.events=[dojo.connect(dojo.doc,"onmousemove",this,"onMouseMove"),dojo.connect(dojo.doc,"onmouseup",this,"onMouseUp"),dojo.connect(dojo.doc,"onkeydown",this,"onKeyDown"),dojo.connect(dojo.doc,"onkeyup",this,"onKeyUp")];var d="dojoDnd"+(a?"Copy":"Move");dojo.addClass(dojo.body(),d)},canDrop:function(o){var t=this.target&&o;this.canDropFlag!=t&&(this.canDropFlag=t,this.avatar.update())},stopDrag:function(){dojo.removeClass(dojo.body(),"dojoDndCopy"),dojo.removeClass(dojo.body(),"dojoDndMove"),dojo.forEach(this.events,dojo.disconnect),this.events=[],this.avatar.destroy(),this.avatar=null,this.source=null,this.nodes=[]},makeAvatar:function(){return new dojo.dnd.Avatar(this)},updateAvatar:function(){this.avatar.update()},onMouseMove:function(o){var t=this.avatar;if(t){dojo.dnd.autoScroll(o),dojo.marginBox(t.node,{l:o.pageX+this.OFFSET_X,t:o.pageY+this.OFFSET_Y});var a=Boolean(this.source.copyState(dojo.dnd.getCopyKeyState(o)));this.copy!=a&&this._setCopyStatus(a)}},onMouseUp:function(o){if(!(!this.avatar||"mouseButton"in this.source&&this.source.mouseButton!=o.button)){if(this.target&&this.canDropFlag){var t=[this.source,this.nodes,Boolean(this.source.copyState(dojo.dnd.getCopyKeyState(o))),this.target];dojo.publish("/dnd/drop/before",t),dojo.publish("/dnd/drop",t)}else dojo.publish("/dnd/cancel");this.stopDrag()}},onKeyDown:function(o){if(this.avatar)switch(o.keyCode){case dojo.keys.CTRL:var t=Boolean(this.source.copyState(!0));this.copy!=t&&this._setCopyStatus(t);break;case dojo.keys.ESCAPE:dojo.publish("/dnd/cancel"),this.stopDrag()}},onKeyUp:function(o){if(this.avatar&&o.keyCode==dojo.keys.CTRL){var t=Boolean(this.source.copyState(!1));this.copy!=t&&this._setCopyStatus(t)}},_setCopyStatus:function(o){this.copy=o,this.source._markDndStatus(this.copy),this.updateAvatar(),dojo.removeClass(dojo.body(),"dojoDnd"+(this.copy?"Move":"Copy")),dojo.addClass(dojo.body(),"dojoDnd"+(this.copy?"Copy":"Move"))}}),dojo.dnd._manager=null,dojo.dnd.manager=function(){return dojo.dnd._manager||(dojo.dnd._manager=new dojo.dnd.Manager),dojo.dnd._manager});