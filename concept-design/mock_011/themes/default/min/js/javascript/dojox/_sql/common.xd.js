dojo._xdResourceLoaded({depends:[["provide","dojox._sql.common"],["require","dojox._sql._crypto"]],defineResource:function(t){t._hasResource["dojox._sql.common"]||(t._hasResource["dojox._sql.common"]=!0,t.provide("dojox._sql.common"),t.require("dojox._sql._crypto"),dojox.sql=new Function("return dojox.sql._exec(arguments);"),t.mixin(dojox.sql,{dbName:null,debug:t.exists("dojox.sql.debug")?dojox.sql.debug:!1,open:function(t){if(!this._dbOpen||t&&t!=this.dbName){this.dbName||(this.dbName="dot_store_"+window.location.href.replace(/[^0-9A-Za-z_]/g,"_")),t||(t=this.dbName);try{this._initDb(),this.db.open(t),this._dbOpen=!0}catch(e){throw e.message||e}}},close:function(e){if(!t.isIE&&(this._dbOpen||e&&e!=this.dbName)){e||(e=this.dbName);try{this.db.close(e),this._dbOpen=!1}catch(o){throw o.message||o}}},_exec:function(e){try{this._initDb(),this._dbOpen||(this.open(),this._autoClose=!0);var o=null,i=null,s=null,n=t._toArray(e);if(o=n.splice(0,1)[0],(this._needsEncrypt(o)||this._needsDecrypt(o))&&(i=n.splice(n.length-1,1)[0],s=n.splice(n.length-1,1)[0]),this.debug&&this._printDebugSQL(o,n),this._needsEncrypt(o)){{new dojox.sql._SQLCrypto("encrypt",o,s,n,i)}return}if(this._needsDecrypt(o)){{new dojox.sql._SQLCrypto("decrypt",o,s,n,i)}return}var r=this.db.execute(o,n);return r=this._normalizeResults(r),this._autoClose&&this.close(),r}catch(l){if(l=l.message||l,console.debug("SQL Exception: "+l),this._autoClose)try{this.close()}catch(c){console.debug("Error closing database: "+c.message||c)}throw l}},_initDb:function(){if(!this.db)try{this.db=google.gears.factory.create("beta.database","1.0")}catch(e){throw t.setObject("google.gears.denied",!0),dojox.off.onFrameworkEvent("coreOperationFailed"),"Google Gears must be allowed to run"}},_printDebugSQL:function(t,e){for(var o='dojox.sql("'+t+'"',i=0;i<e.length;i++)o+="string"==typeof e[i]?', "'+e[i]+'"':", "+e[i];o+=")",console.debug(o)},_normalizeResults:function(t){var e=[];if(!t)return[];for(;t.isValidRow();){for(var o={},i=0;i<t.fieldCount();i++){var s=t.fieldName(i),n=t.field(i);o[s]=n}e.push(o),t.next()}return t.close(),e},_needsEncrypt:function(t){return/encrypt\([^\)]*\)/i.test(t)},_needsDecrypt:function(t){return/decrypt\([^\)]*\)/i.test(t)}}),t.declare("dojox.sql._SQLCrypto",null,{constructor:function(t,e,o,i,s){"encrypt"==t?this._execEncryptSQL(e,o,i,s):this._execDecryptSQL(e,o,i,s)},_execEncryptSQL:function(t,e,o,i){var s=this._stripCryptoSQL(t),n=this._flagEncryptedArgs(t,o),r=this;this._encrypt(s,e,o,n,function(o){var n=!1,l=[],c=null;try{l=dojox.sql.db.execute(s,o)}catch(a){n=!0,c=a.message||a}if(null!=c){if(dojox.sql._autoClose)try{dojox.sql.close()}catch(d){}return i(null,!0,c.toString()),void 0}if(l=dojox.sql._normalizeResults(l),dojox.sql._autoClose&&dojox.sql.close(),dojox.sql._needsDecrypt(t)){var h=r._determineDecryptedColumns(t);r._decrypt(l,h,e,function(t){i(t,!1,null)})}else i(l,!1,null)})},_execDecryptSQL:function(t,e,o,i){var s=this._stripCryptoSQL(t),n=this._determineDecryptedColumns(t),r=!1,l=[],c=null;try{l=dojox.sql.db.execute(s,o)}catch(a){r=!0,c=a.message||a}if(null!=c){if(dojox.sql._autoClose)try{dojox.sql.close()}catch(d){}return i(l,!0,c.toString()),void 0}l=dojox.sql._normalizeResults(l),dojox.sql._autoClose&&dojox.sql.close(),this._decrypt(l,n,e,function(t){i(t,!1,null)})},_encrypt:function(e,o,i,s,n){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalArgs=i;for(var r=0;r<i.length;r++)if(s[r]){var l=i[r],c=r;this._totalCrypto++,dojox._sql._crypto.encrypt(l,o,t.hitch(this,function(t){this._finalArgs[c]=t,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&n(this._finalArgs)}))}this._finishedSpawningCrypto=!0},_decrypt:function(t,e,o,i){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalResultSet=t;for(var s=0;s<t.length;s++){var n=t[s];for(var r in n)if("*"==e||e[r]){this._totalCrypto++;var l=n[r];this._decryptSingleColumn(r,l,o,s,function(t){i(t)})}}this._finishedSpawningCrypto=!0},_stripCryptoSQL:function(t){t=t.replace(/DECRYPT\(\*\)/gi,"*");var e=t.match(/ENCRYPT\([^\)]*\)/gi);if(null!=e)for(var o=0;o<e.length;o++){var i=e[o],s=i.match(/ENCRYPT\(([^\)]*)\)/i)[1];t=t.replace(i,s)}if(e=t.match(/DECRYPT\([^\)]*\)/gi),null!=e)for(var o=0;o<e.length;o++){var n=e[o],r=n.match(/DECRYPT\(([^\)]*)\)/i)[1];t=t.replace(n,r)}return t},_flagEncryptedArgs:function(t){for(var e,o=new RegExp(/([\"][^\"]*\?[^\"]*[\"])|([\'][^\']*\?[^\']*[\'])|(\?)/gi),i=0,s=[];null!=(e=o.exec(t));){var n=RegExp.lastMatch+"";if(!/^[\"\']/.test(n)){var r=!1;/ENCRYPT\([^\)]*$/i.test(RegExp.leftContext)&&(r=!0),s[i]=r,i++}}return s},_determineDecryptedColumns:function(e){var o={};if(/DECRYPT\(\*\)/i.test(e))o="*";else for(var i,s=/DECRYPT\((?:\s*\w*\s*\,?)*\)/gi;i=s.exec(e);){var n=new String(RegExp.lastMatch),r=n.replace(/DECRYPT\(/i,"");r=r.replace(/\)/,""),r=r.split(/\s*,\s*/),t.forEach(r,function(t){/\s*\w* AS (\w*)/i.test(t)&&(t=t.match(/\s*\w* AS (\w*)/i)[1]),o[t]=!0})}return o},_decryptSingleColumn:function(e,o,i,s,n){dojox._sql._crypto.decrypt(o,i,t.hitch(this,function(t){this._finalResultSet[s][e]=t,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&n(this._finalResultSet)}))}}))}});