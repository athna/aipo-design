dojo._hasResource["dojox.data.OpmlStore"]||(dojo._hasResource["dojox.data.OpmlStore"]=!0,dojo.provide("dojox.data.OpmlStore"),dojo.require("dojo.data.util.filter"),dojo.require("dojo.data.util.simpleFetch"),dojo.declare("dojox.data.OpmlStore",null,{constructor:function(t){this._xmlData=null,this._arrayOfTopLevelItems=[],this._arrayOfAllItems=[],this._metadataNodes=null,this._loadFinished=!1,this.url=t.url,this._opmlData=t.data,t.label&&(this.label=t.label),this._loadInProgress=!1,this._queuedFetches=[],this._identityMap={},this._identCount=0,this._idProp="_I"},label:"text",url:"",_assertIsItem:function(t){if(!this.isItem(t))throw new Error("dojo.data.OpmlStore: a function was passed an item argument that was not an item")},_assertIsAttribute:function(t){if(!dojo.isString(t))throw new Error("dojox.data.OpmlStore: a function was passed an attribute argument that was not an attribute object nor an attribute name string")},_removeChildNodesThatAreNotElementNodes:function(t,e){var i=t.childNodes;if(0!==i.length){var r,s,o=[];for(r=0;r<i.length;++r)s=i[r],1!=s.nodeType&&o.push(s);for(r=0;r<o.length;++r)s=o[r],t.removeChild(s);if(e)for(r=0;r<i.length;++r)s=i[r],this._removeChildNodesThatAreNotElementNodes(s,e)}},_processRawXmlTree:function(t){this._loadFinished=!0,this._xmlData=t;var e=t.getElementsByTagName("head"),i=e[0];i&&(this._removeChildNodesThatAreNotElementNodes(i),this._metadataNodes=i.childNodes);var r=t.getElementsByTagName("body"),s=r[0];if(s){this._removeChildNodesThatAreNotElementNodes(s,!0);for(var o=r[0].childNodes,a=0;a<o.length;++a){var n=o[a];"outline"==n.tagName&&(this._identityMap[this._identCount]=n,this._identCount++,this._arrayOfTopLevelItems.push(n),this._arrayOfAllItems.push(n),this._checkChildNodes(n))}}},_checkChildNodes:function(t){if(t.firstChild)for(var e=0;e<t.childNodes.length;e++){var i=t.childNodes[e];"outline"==i.tagName&&(this._identityMap[this._identCount]=i,this._identCount++,this._arrayOfAllItems.push(i),this._checkChildNodes(i))}},_getItemsArray:function(t){return t&&t.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},getValue:function(t,e,i){if(this._assertIsItem(t),this._assertIsAttribute(e),"children"==e)return t.firstChild||i;var r=t.getAttribute(e);return void 0!==r?r:i},getValues:function(t,e){this._assertIsItem(t),this._assertIsAttribute(e);var i=[];if("children"==e)for(var r=0;r<t.childNodes.length;++r)i.push(t.childNodes[r]);else null!==t.getAttribute(e)&&i.push(t.getAttribute(e));return i},getAttributes:function(t){this._assertIsItem(t);for(var e=[],i=t,r=i.attributes,s=0;s<r.length;++s){var o=r.item(s);e.push(o.nodeName)}return i.childNodes.length>0&&e.push("children"),e},hasAttribute:function(t,e){return this.getValues(t,e).length>0},containsValue:function(t,e,i){var r=void 0;return"string"==typeof i&&(r=dojo.data.util.filter.patternToRegExp(i,!1)),this._containsValue(t,e,i,r)},_containsValue:function(t,e,i,r){for(var s=this.getValues(t,e),o=0;o<s.length;++o){var a=s[o];if("string"==typeof a&&r)return null!==a.match(r);if(i===a)return!0}return!1},isItem:function(t){return t&&1==t.nodeType&&"outline"==t.tagName&&t.ownerDocument===this._xmlData},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(){},getLabel:function(t){return this.isItem(t)?this.getValue(t,this.label):void 0},getLabelAttributes:function(){return[this.label]},_fetchItems:function(t,e){var i=this,r=function(t,r){var s=null;if(t.query){s=[];var o=t.queryOptions?t.queryOptions.ignoreCase:!1,a={};for(var n in t.query){var l=t.query[n];"string"==typeof l&&(a[n]=dojo.data.util.filter.patternToRegExp(l,o))}for(var h=0;h<r.length;++h){var d=!0,u=r[h];for(var n in t.query){var l=t.query[n];i._containsValue(u,n,l,a[n])||(d=!1)}d&&s.push(u)}}else r.length>0&&(s=r.slice(0,r.length));e(s,t)};if(this._loadFinished)r(t,this._getItemsArray(t.queryOptions));else if(this._loadInProgress)this._queuedFetches.push({args:t,filter:r});else if(""!==this.url){this._loadInProgress=!0;var s={url:i.url,handleAs:"xml"},o=dojo.xhrGet(s);o.addCallback(function(e){i._processRawXmlTree(e),r(t,i._getItemsArray(t.queryOptions)),i._handleQueuedFetches()}),o.addErrback(function(t){throw t})}else{if(!this._opmlData)throw new Error("dojox.data.OpmlStore: No OPML source data was provided as either URL or XML data input.");this._processRawXmlTree(this._opmlData),this._opmlData=null,r(t,this._getItemsArray(t.queryOptions))}},getFeatures:function(){var t={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0};return t},getIdentity:function(t){if(this.isItem(t))for(var e in this._identityMap)if(this._identityMap[e]===t)return e;return null},fetchItemByIdentity:function(t){if(this._loadFinished){var e=this._identityMap[t.identity];if(this.isItem(e)||(e=null),t.onItem){var i=t.scope?t.scope:dojo.global;t.onItem.call(i,e)}}else{var r=this;if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:t});else{this._loadInProgress=!0;var s={url:r.url,handleAs:"xml"},o=dojo.xhrGet(s);o.addCallback(function(e){var i=t.scope?t.scope:dojo.global;try{r._processRawXmlTree(e);var s=r._identityMap[t.identity];r.isItem(s)||(s=null),t.onItem&&t.onItem.call(i,s),r._handleQueuedFetches()}catch(o){t.onError&&t.onError.call(i,o)}}),o.addErrback(function(e){if(this._loadInProgress=!1,t.onError){var i=t.scope?t.scope:dojo.global;t.onError.call(i,e)}})}else if(this._opmlData){this._processRawXmlTree(this._opmlData),this._opmlData=null;var e=this._identityMap[t.identity];if(r.isItem(e)||(e=null),t.onItem){var i=t.scope?t.scope:dojo.global;t.onItem.call(i,e)}}}},getIdentityAttributes:function(){return null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var t=0;t<this._queuedFetches.length;t++){var e=this._queuedFetches[t],i=e.args,r=e.filter;r?r(i,this._getItemsArray(i.queryOptions)):this.fetchItemByIdentity(i)}this._queuedFetches=[]}},close:function(){}}),dojo.extend(dojox.data.OpmlStore,dojo.data.util.simpleFetch));