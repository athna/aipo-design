dojo._xdResourceLoaded({depends:[["provide","dijit._editor.plugins.EnterKeyHandling"]],defineResource:function(e){e._hasResource["dijit._editor.plugins.EnterKeyHandling"]||(e._hasResource["dijit._editor.plugins.EnterKeyHandling"]=!0,e.provide("dijit._editor.plugins.EnterKeyHandling"),e.declare("dijit._editor.plugins.EnterKeyHandling",null,{blockNodeForEnter:"P",constructor:function(t){t&&e.mixin(this,t)},setEditor:function(t){if(this.editor=t,"BR"==this.blockNodeForEnter)e.isIE?(t.contentDomPreFilters.push(e.hitch(this,"regularPsToSingleLinePs")),t.contentDomPostFilters.push(e.hitch(this,"singleLinePsToRegularPs")),t.onLoadDeferred.addCallback(e.hitch(this,"_fixNewLineBehaviorForIE"))):t.onLoadDeferred.addCallback(e.hitch(this,function(e){try{this.editor.document.execCommand("insertBrOnReturn",!1,!0)}catch(t){}return e}));else if(this.blockNodeForEnter){e.require("dijit._editor.range");var i=e.hitch(this,this.handleEnterKey);t.addKeyHandler(13,0,i),t.addKeyHandler(13,2,i),this.connect(this.editor,"onKeyPressed","onKeyPressed")}},connect:function(t,i,n){this._connects||(this._connects=[]),this._connects.push(e.connect(t,i,this,n))},destroy:function(){e.forEach(this._connects,e.disconnect),this._connects=[]},onKeyPressed:function(){if(this._checkListLater){if(e.withGlobal(this.editor.window,"isCollapsed",dijit._editor.selection)&&!e.withGlobal(this.editor.window,"hasAncestorElement",dijit._editor.selection,["LI"])){dijit._editor.RichText.prototype.execCommand.apply(this.editor,["formatblock",this.blockNodeForEnter]);var t=e.withGlobal(this.editor.window,"getAncestorElement",dijit._editor.selection,[this.blockNodeForEnter]);if(t){if(t.innerHTML=this.bogusHtmlContent,e.isIE){var i=this.editor.document.selection.createRange();i.move("character",-1),i.select()}}else alert("onKeyPressed: Can not find the new block node")}this._checkListLater=!1}else this._pressedEnterInBlock&&(this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&nbsp;",blockNodes:/^(?:H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(t){if(!this.blockNodeForEnter)return!0;if(t.shiftKey||"BR"==this.blockNodeForEnter){var i=e.withGlobal(this.editor.window,"getParentElement",dijit._editor.selection),n=dijit.range.getAncestor(i,this.editor.blockNodes);if(n){if("LI"==n.tagName)return!0;var o=dijit.range.getSelection(this.editor.window),r=o.getRangeAt(0);if(r.collapsed||r.deleteContents(),dijit.range.atBeginningOfContainer(n,r.startContainer,r.startOffset))e.place(this.editor.document.createElement("br"),n,"before");else{if(!dijit.range.atEndOfContainer(n,r.startContainer,r.startOffset))return!0;e.place(this.editor.document.createElement("br"),n,"after");var d=dijit.range.create();d.setStartAfter(n),o.removeAllRanges(),o.addRange(d)}}else dijit._editor.RichText.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var l=!0,o=dijit.range.getSelection(this.editor.window),r=o.getRangeAt(0);r.collapsed||r.deleteContents();var s=dijit.range.getBlockAncestor(r.endContainer,null,this.editor.editNode);if(s.blockNode&&"LI"==s.blockNode.tagName)return this._checkListLater=!0,!0;if(this._checkListLater=!1,!s.blockNode){if(this.editor.document.execCommand("formatblock",!1,this.blockNodeForEnter),s={blockNode:e.withGlobal(this.editor.window,"getAncestorElement",dijit._editor.selection,[this.blockNodeForEnter]),blockContainer:this.editor.editNode},s.blockNode){if(0==(s.blockNode.textContent||s.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(s.blockNode),!1}else s.blockNode=this.editor.editNode;o=dijit.range.getSelection(this.editor.window),r=o.getRangeAt(0)}var a=this.editor.document.createElement(this.blockNodeForEnter);if(a.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(s.blockNode),dijit.range.atEndOfContainer(s.blockNode,r.endContainer,r.endOffset)){s.blockNode===s.blockContainer?s.blockNode.appendChild(a):e.place(a,s.blockNode,"after"),l=!1;var d=dijit.range.create();d.setStart(a,0),o.removeAllRanges(),o.addRange(d),this.editor.height&&a.scrollIntoView(!1)}else dijit.range.atBeginningOfContainer(s.blockNode,r.startContainer,r.startOffset)?(s.blockNode===s.blockContainer?e.place(a,s.blockNode,"first"):e.place(a,s.blockNode,"before"),this.editor.height&&a.scrollIntoView(!1),l=!1):e.isMoz&&(this._pressedEnterInBlock=s.blockNode);return l},removeTrailingBr:function(t){if(/P|DIV|LI/i.test(t.tagName))var i=t;else var i=dijit._editor.selection.getParentOfType(t,["P","DIV","LI"]);i&&(i.lastChild&&(i.childNodes.length>1&&3==i.lastChild.nodeType&&/^[\s\xAD]*$/.test(i.lastChild.nodeValue)&&e._destroyElement(i.lastChild),i.lastChild&&"BR"==i.lastChild.tagName&&e._destroyElement(i.lastChild)),0==i.childNodes.length&&(i.innerHTML=this.bogusHtmlContent))},_fixNewLineBehaviorForIE:function(t){if("undefined"==typeof this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS){var i="p{margin:0 !important;}",n=function(t,i){if(t){i||(i=document);var n=i.createElement("style");n.setAttribute("type","text/css");var o=i.getElementsByTagName("head")[0];if(!o)return console.debug("No head tag in document, aborting styles"),void 0;if(o.appendChild(n),n.styleSheet){var r=function(){try{n.styleSheet.cssText=t}catch(i){e.debug(i)}};n.styleSheet.disabled?setTimeout(r,10):r()}else{var d=i.createTextNode(t);n.appendChild(d)}return n}};return n(i,this.editor.document),this.editor.document.__INSERTED_EDITIOR_NEWLINE_CSS=!0,t}},regularPsToSingleLinePs:function(t,i){function n(t){function i(e){var t=e[0].ownerDocument.createElement("p");e[0].parentNode.insertBefore(t,e[0]);for(var i=0;i<e.length;i++)t.appendChild(e[i])}for(var n,o=0,r=[];o<t.childNodes.length;){if(n=t.childNodes[o],"BR"!=n.nodeName&&1==n.nodeType&&"block"!=e.style(n,"display"))r.push(n);else{{n.nextSibling}r.length&&(i(r),o=o+1-r.length,"BR"==n.nodeName&&e._destroyElement(n)),r=[]}o++}r.length&&i(r)}function o(t){for(var i=null,n=[],o=t.childNodes.length-1,r=o;r>=0;r--)if(i=t.childNodes[r],"BR"==i.nodeName){var d=i.ownerDocument.createElement("p");e.place(d,t,"after"),0==n.length&&r!=o&&(d.innerHTML="&nbsp;"),e.forEach(n,function(e){d.appendChild(e)}),e._destroyElement(i),n=[]}else n.unshift(i)}var r=[],d=t.getElementsByTagName("p");return e.forEach(d,function(e){r.push(e)}),e.forEach(r,function(t){if(t.previousSibling&&("P"==t.previousSibling.nodeName||"block"!=e.style(t.previousSibling,"display"))){var n=t.parentNode.insertBefore(this.document.createElement("p"),t);n.innerHTML=i?"":"&nbsp;"}o(t)},this.editor),n(t),t},singleLinePsToRegularPs:function(t){function i(e){for(var t=e.getElementsByTagName("p"),i=[],n=0;n<t.length;n++){for(var o=t[n],r=!1,d=0;d<i.length;d++)if(i[d]===o.parentNode){r=!0;break}r||i.push(o.parentNode)}return i}function n(t){return 1!=t.nodeType||"P"!=t.tagName?"block"==e.style(t,"display"):t.childNodes.length&&"&nbsp;"!=t.innerHTML?void 0:!0}for(var o=i(t),r=0;r<o.length;r++)for(var d=o[r],l=null,s=d.firstChild,a=null;s;){if("1"!=s.nodeType||"P"!=s.tagName)l=null;else if(n(s))a=s,l=null;else if(null==l)l=s;else{for(l.lastChild&&"BR"==l.lastChild.nodeName||!s.firstChild||"BR"==s.firstChild.nodeName||l.appendChild(this.editor.document.createElement("br"));s.firstChild;)l.appendChild(s.firstChild);a=s}s=s.nextSibling,a&&(e._destroyElement(a),a=null)}return t}}))}});