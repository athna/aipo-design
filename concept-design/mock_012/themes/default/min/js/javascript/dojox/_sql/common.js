dojo._hasResource["dojox._sql.common"]||(dojo._hasResource["dojox._sql.common"]=!0,dojo.provide("dojox._sql.common"),dojo.require("dojox._sql._crypto"),dojox.sql=new Function("return dojox.sql._exec(arguments);"),dojo.mixin(dojox.sql,{dbName:null,debug:dojo.exists("dojox.sql.debug")?dojox.sql.debug:!1,open:function(t){if(!this._dbOpen||t&&t!=this.dbName){this.dbName||(this.dbName="dot_store_"+window.location.href.replace(/[^0-9A-Za-z_]/g,"_")),t||(t=this.dbName);try{this._initDb(),this.db.open(t),this._dbOpen=!0}catch(e){throw e.message||e}}},close:function(t){if(!dojo.isIE&&(this._dbOpen||t&&t!=this.dbName)){t||(t=this.dbName);try{this.db.close(t),this._dbOpen=!1}catch(e){throw e.message||e}}},_exec:function(t){try{this._initDb(),this._dbOpen||(this.open(),this._autoClose=!0);var e=null,o=null,i=null,s=dojo._toArray(t);if(e=s.splice(0,1)[0],(this._needsEncrypt(e)||this._needsDecrypt(e))&&(o=s.splice(s.length-1,1)[0],i=s.splice(s.length-1,1)[0]),this.debug&&this._printDebugSQL(e,s),this._needsEncrypt(e)){{new dojox.sql._SQLCrypto("encrypt",e,i,s,o)}return}if(this._needsDecrypt(e)){{new dojox.sql._SQLCrypto("decrypt",e,i,s,o)}return}var n=this.db.execute(e,s);return n=this._normalizeResults(n),this._autoClose&&this.close(),n}catch(r){if(r=r.message||r,console.debug("SQL Exception: "+r),this._autoClose)try{this.close()}catch(l){console.debug("Error closing database: "+l.message||l)}throw r}},_initDb:function(){if(!this.db)try{this.db=google.gears.factory.create("beta.database","1.0")}catch(t){throw dojo.setObject("google.gears.denied",!0),dojox.off.onFrameworkEvent("coreOperationFailed"),"Google Gears must be allowed to run"}},_printDebugSQL:function(t,e){for(var o='dojox.sql("'+t+'"',i=0;i<e.length;i++)o+="string"==typeof e[i]?', "'+e[i]+'"':", "+e[i];o+=")",console.debug(o)},_normalizeResults:function(t){var e=[];if(!t)return[];for(;t.isValidRow();){for(var o={},i=0;i<t.fieldCount();i++){var s=t.fieldName(i),n=t.field(i);o[s]=n}e.push(o),t.next()}return t.close(),e},_needsEncrypt:function(t){return/encrypt\([^\)]*\)/i.test(t)},_needsDecrypt:function(t){return/decrypt\([^\)]*\)/i.test(t)}}),dojo.declare("dojox.sql._SQLCrypto",null,{constructor:function(t,e,o,i,s){"encrypt"==t?this._execEncryptSQL(e,o,i,s):this._execDecryptSQL(e,o,i,s)},_execEncryptSQL:function(t,e,o,i){var s=this._stripCryptoSQL(t),n=this._flagEncryptedArgs(t,o),r=this;this._encrypt(s,e,o,n,function(o){var n=!1,l=[],c=null;try{l=dojox.sql.db.execute(s,o)}catch(a){n=!0,c=a.message||a}if(null!=c){if(dojox.sql._autoClose)try{dojox.sql.close()}catch(d){}return i(null,!0,c.toString()),void 0}if(l=dojox.sql._normalizeResults(l),dojox.sql._autoClose&&dojox.sql.close(),dojox.sql._needsDecrypt(t)){var h=r._determineDecryptedColumns(t);r._decrypt(l,h,e,function(t){i(t,!1,null)})}else i(l,!1,null)})},_execDecryptSQL:function(t,e,o,i){var s=this._stripCryptoSQL(t),n=this._determineDecryptedColumns(t),r=!1,l=[],c=null;try{l=dojox.sql.db.execute(s,o)}catch(a){r=!0,c=a.message||a}if(null!=c){if(dojox.sql._autoClose)try{dojox.sql.close()}catch(d){}return i(l,!0,c.toString()),void 0}l=dojox.sql._normalizeResults(l),dojox.sql._autoClose&&dojox.sql.close(),this._decrypt(l,n,e,function(t){i(t,!1,null)})},_encrypt:function(t,e,o,i,s){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalArgs=o;for(var n=0;n<o.length;n++)if(i[n]){var r=o[n],l=n;this._totalCrypto++,dojox._sql._crypto.encrypt(r,e,dojo.hitch(this,function(t){this._finalArgs[l]=t,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&s(this._finalArgs)}))}this._finishedSpawningCrypto=!0},_decrypt:function(t,e,o,i){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalResultSet=t;for(var s=0;s<t.length;s++){var n=t[s];for(var r in n)if("*"==e||e[r]){this._totalCrypto++;var l=n[r];this._decryptSingleColumn(r,l,o,s,function(t){i(t)})}}this._finishedSpawningCrypto=!0},_stripCryptoSQL:function(t){t=t.replace(/DECRYPT\(\*\)/gi,"*");var e=t.match(/ENCRYPT\([^\)]*\)/gi);if(null!=e)for(var o=0;o<e.length;o++){var i=e[o],s=i.match(/ENCRYPT\(([^\)]*)\)/i)[1];t=t.replace(i,s)}if(e=t.match(/DECRYPT\([^\)]*\)/gi),null!=e)for(var o=0;o<e.length;o++){var n=e[o],r=n.match(/DECRYPT\(([^\)]*)\)/i)[1];t=t.replace(n,r)}return t},_flagEncryptedArgs:function(t){for(var e,o=new RegExp(/([\"][^\"]*\?[^\"]*[\"])|([\'][^\']*\?[^\']*[\'])|(\?)/gi),i=0,s=[];null!=(e=o.exec(t));){var n=RegExp.lastMatch+"";if(!/^[\"\']/.test(n)){var r=!1;/ENCRYPT\([^\)]*$/i.test(RegExp.leftContext)&&(r=!0),s[i]=r,i++}}return s},_determineDecryptedColumns:function(t){var e={};if(/DECRYPT\(\*\)/i.test(t))e="*";else for(var o,i=/DECRYPT\((?:\s*\w*\s*\,?)*\)/gi;o=i.exec(t);){var s=new String(RegExp.lastMatch),n=s.replace(/DECRYPT\(/i,"");n=n.replace(/\)/,""),n=n.split(/\s*,\s*/),dojo.forEach(n,function(t){/\s*\w* AS (\w*)/i.test(t)&&(t=t.match(/\s*\w* AS (\w*)/i)[1]),e[t]=!0})}return e},_decryptSingleColumn:function(t,e,o,i,s){dojox._sql._crypto.decrypt(e,o,dojo.hitch(this,function(e){this._finalResultSet[i][t]=e,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&s(this._finalResultSet)}))}}));