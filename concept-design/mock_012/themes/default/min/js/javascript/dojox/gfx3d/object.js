if(!dojo._hasResource["dojox.gfx3d.object"]){dojo._hasResource["dojox.gfx3d.object"]=!0,dojo.provide("dojox.gfx3d.object"),dojo.require("dojox.gfx"),dojo.require("dojox.gfx3d.lighting"),dojo.require("dojox.gfx3d.scheduler"),dojo.require("dojox.gfx3d.vector"),dojo.require("dojox.gfx3d.gradient");var out=function(t,e){arguments.length>1&&(t=e);for(var o in t);};dojo.declare("dojox.gfx3d.Object",null,{constructor:function(){this.object=null,this.matrix=null,this.cache=null,this.renderer=null,this.parent=null,this.strokeStyle=null,this.fillStyle=null,this.shape=null},setObject:function(t){return this.object=dojox.gfx.makeParameters(this.object,t),this},setTransform:function(t){return this.matrix=dojox.gfx3d.matrix.clone(t?dojox.gfx3d.matrix.normalize(t):dojox.gfx3d.identity,!0),this},applyRightTransform:function(t){return t?this.setTransform([this.matrix,t]):this},applyLeftTransform:function(t){return t?this.setTransform([t,this.matrix]):this},applyTransform:function(t){return t?this.setTransform([this.matrix,t]):this},setFill:function(t){return this.fillStyle=t,this},setStroke:function(t){return this.strokeStyle=t,this},toStdFill:function(t,e){return this.fillStyle&&"undefined"!=typeof this.fillStyle.type?t[this.fillStyle.type](e,this.fillStyle.finish,this.fillStyle.color):this.fillStyle},invalidate:function(){this.renderer.addTodo(this)},destroy:function(){if(this.shape){var t=this.shape.getParent();t&&t.remove(this.shape),this.shape=null}},render:function(){throw"Pure virtual function, not implemented"},draw:function(){throw"Pure virtual function, not implemented"},getZOrder:function(){return 0},getOutline:function(){return null}}),dojo.declare("dojox.gfx3d.Scene",dojox.gfx3d.Object,{constructor:function(){this.objects=[],this.todos=[],this.schedule=dojox.gfx3d.scheduler.zOrder,this._draw=dojox.gfx3d.drawer.conservative},setFill:function(t){return this.fillStyle=t,dojo.forEach(this.objects,function(e){e.setFill(t)}),this},setStroke:function(t){return this.strokeStyle=t,dojo.forEach(this.objects,function(e){e.setStroke(t)}),this},render:function(t,e){var o=dojox.gfx3d.matrix.multiply(t,this.matrix);e&&(this.todos=this.objects),dojo.forEach(this.todos,function(t){t.render(o,e)})},draw:function(){this.objects=this.schedule(this.objects),this._draw(this.todos,this.objects,this.renderer)},addTodo:function(t){dojo.every(this.todos,function(e){return e!=t})&&(this.todos.push(t),this.invalidate())},invalidate:function(){this.parent.addTodo(this)},getZOrder:function(){var t=0;return dojo.forEach(this.objects,function(e){t+=e.getZOrder()}),this.objects.length>1?t/this.objects.length:0}}),dojo.declare("dojox.gfx3d.Edges",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultEdges)},setObject:function(t,e){return this.object=dojox.gfx.makeParameters(this.object,t instanceof Array?{points:t,style:e}:t),this},getZOrder:function(){var t=0;return dojo.forEach(this.cache,function(e){t+=e.z}),this.cache.length>1?t/this.cache.length:0},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix);this.cache=dojo.map(this.object.points,function(t){return dojox.gfx3d.matrix.multiplyPoint(e,t)})},draw:function(){var t=this.cache;this.shape?this.shape.setShape(""):this.shape=this.renderer.createPath();var e=this.shape.setAbsoluteMode("absolute");if("strip"==this.object.style||"loop"==this.object.style)e.moveTo(t[0].x,t[0].y),dojo.forEach(t.slice(1),function(t){e.lineTo(t.x,t.y)}),"loop"==this.object.style&&e.closePath();else for(var o=0;o<this.cache.length;)e.moveTo(t[o].x,t[o].y),o++,e.lineTo(t[o].x,t[o].y),o++;e.setStroke(this.strokeStyle)}}),dojo.declare("dojox.gfx3d.Orbit",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultOrbit)},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix),o=[0,Math.PI/4,Math.PI/3],i=dojox.gfx3d.matrix.multiplyPoint(e,this.object.center),r=dojo.map(o,function(t){return{x:this.center.x+this.radius*Math.cos(t),y:this.center.y+this.radius*Math.sin(t),z:this.center.z}},this.object);r=dojo.map(r,function(t){return dojox.gfx3d.matrix.multiplyPoint(e,t)});var s=dojox.gfx3d.vector.normalize(r);r=dojo.map(r,function(t){return dojox.gfx3d.vector.substract(t,i)});var n={xx:r[0].x*r[0].y,xy:r[0].y*r[0].y,xz:1,yx:r[1].x*r[1].y,yy:r[1].y*r[1].y,yz:1,zx:r[2].x*r[2].y,zy:r[2].y*r[2].y,zz:1,dx:0,dy:0,dz:0},h=dojo.map(r,function(t){return-Math.pow(t.x,2)}),a=dojox.gfx3d.matrix.multiplyPoint(dojox.gfx3d.matrix.invert(n),h[0],h[1],h[2]),c=Math.atan2(a.x,1-a.y)/2,d=dojo.map(r,function(t){return dojox.gfx.matrix.multiplyPoint(dojox.gfx.matrix.rotate(-c),t.x,t.y)}),l=Math.pow(d[0].x,2),h=Math.pow(d[0].y,2),x=Math.pow(d[1].x,2),u=Math.pow(d[1].y,2),f=Math.sqrt((l*u-h*x)/(u-h)),j=Math.sqrt((l*u-h*x)/(l-x));this.cache={cx:i.x,cy:i.y,rx:f,ry:j,theta:c,normal:s}},draw:function(t){this.shape?this.shape.setShape(this.cache):this.shape=this.renderer.createEllipse(this.cache),this.shape.applyTransform(dojox.gfx.matrix.rotateAt(this.cache.theta,this.cache.cx,this.cache.cy)).setStroke(this.strokeStyle).setFill(this.toStdFill(t,this.cache.normal))}}),dojo.declare("dojox.gfx3d.Path3d",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultPath3d),this.segments=[],this.absolute=!0,this.last={},this.path=""},_collectArgs:function(t,e){for(var o=0;o<e.length;++o){var i=e[o];"boolean"==typeof i?t.push(i?1:0):"number"==typeof i?t.push(i):i instanceof Array?this._collectArgs(t,i):"x"in i&&"y"in i&&(t.push(i.x),t.push(i.y))}},_validSegments:{m:3,l:3,z:0},_pushSegment:function(t,e){var o=this._validSegments[t.toLowerCase()];if("number"==typeof o)if(o){if(e.length>=o){var i={action:t,args:e.slice(0,e.length-e.length%o)};this.segments.push(i)}}else{var i={action:t,args:[]};this.segments.push(i)}},moveTo:function(){var t=[];return this._collectArgs(t,arguments),this._pushSegment(this.absolute?"M":"m",t),this},lineTo:function(){var t=[];return this._collectArgs(t,arguments),this._pushSegment(this.absolute?"L":"l",t),this},closePath:function(){return this._pushSegment("Z",[]),this},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix),o="",i=this._validSegments;dojo.forEach(this.segments,function(t){o+=t.action;for(var r=0;r<t.args.length;r+=i[t.action.toLowerCase()]){var s=dojox.gfx3d.matrix.multiplyPoint(e,t.args[r],t.args[r+1],t.args[r+2]);o+=" "+s.x+" "+s.y}}),this.cache=o},_draw:function(){return this.parent.createPath(this.cache)}}),dojo.declare("dojox.gfx3d.Triangles",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultTriangles)},setObject:function(t,e){return this.object=t instanceof Array?dojox.gfx.makeParameters(this.object,{points:t,style:e}):dojox.gfx.makeParameters(this.object,t),this},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix),o=dojo.map(this.object.points,function(t){return dojox.gfx3d.matrix.multiplyPoint(e,t)});this.cache=[];var i=o.slice(0,2),r=o[0];if("strip"==this.object.style)dojo.forEach(o.slice(2),function(t){i.push(t),i.push(i[0]),this.cache.push(i),i=i.slice(1,3)},this);else if("fan"==this.object.style)dojo.forEach(o.slice(2),function(t){i.push(t),i.push(r),this.cache.push(i),i=[r,t]},this);else for(var s=0;s<o.length;)this.cache.push([o[s],o[s+1],o[s+2],o[s]]),s+=3},draw:function(t){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(t){return t}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),dojo.forEach(this.cache,function(e){this.shape.createPolyline(e).setStroke(this.strokeStyle).setFill(this.toStdFill(t,dojox.gfx3d.vector.normalize(e)))},this)},getZOrder:function(){var t=0;return dojo.forEach(this.cache,function(e){t+=(e[0].z+e[1].z+e[2].z)/3}),this.cache.length>1?t/this.cache.length:0}}),dojo.declare("dojox.gfx3d.Quads",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultQuads)},setObject:function(t,e){return this.object=dojox.gfx.makeParameters(this.object,t instanceof Array?{points:t,style:e}:t),this},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix),o=dojo.map(this.object.points,function(t){return dojox.gfx3d.matrix.multiplyPoint(e,t)});if(this.cache=[],"strip"==this.object.style)for(var i=o.slice(0,2),r=2;r<o.length;)i=i.concat([o[r],o[r+1],i[0]]),this.cache.push(i),i=i.slice(2,4),r+=2;else for(var r=0;r<o.length;)this.cache.push([o[r],o[r+1],o[r+2],o[r+3],o[r]]),r+=4},draw:function(t){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(t){return t}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var e=0;e<this.cache.length;e++)this.shape.createPolyline(this.cache[e]).setStroke(this.strokeStyle).setFill(this.toStdFill(t,dojox.gfx3d.vector.normalize(this.cache[e])))},getZOrder:function(){for(var t=0,e=0;e<this.cache.length;e++){var o=this.cache[e];t+=(o[0].z+o[1].z+o[2].z+o[3].z)/4}return this.cache.length>1?t/this.cache.length:0}}),dojo.declare("dojox.gfx3d.Polygon",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultPolygon)},setObject:function(t){return this.object=dojox.gfx.makeParameters(this.object,t instanceof Array?{path:t}:t),this},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix);this.cache=dojo.map(this.object.path,function(t){return dojox.gfx3d.matrix.multiplyPoint(e,t)}),this.cache.push(this.cache[0])},draw:function(t){this.shape?this.shape.setShape({points:this.cache}):this.shape=this.renderer.createPolyline({points:this.cache}),this.shape.setStroke(this.strokeStyle).setFill(this.toStdFill(t,dojox.gfx3d.matrix.normalize(this.cache)))},getZOrder:function(){for(var t=0,e=0;e<this.cache.length;e++)t+=this.cache[e].z;return this.cache.length>1?t/this.cache.length:0},getOutline:function(){return this.cache.slice(0,3)}}),dojo.declare("dojox.gfx3d.Cube",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultCube),this.polygons=[]},setObject:function(t){this.object=dojox.gfx.makeParameters(this.object,t)},render:function(t){var e=this.object.top,o=this.object.bottom,i={x:o.x,y:e.y,z:e.z},r={x:o.x,y:o.y,z:e.z},s={x:e.x,y:o.y,z:e.z},n={x:e.x,y:e.y,z:o.z},h={x:o.x,y:e.y,z:o.z},a={x:e.x,y:o.y,z:o.z},c=[e,i,r,s,n,h,o,a],d=dojox.gfx3d.matrix.multiply(t,this.matrix),l=dojo.map(c,function(t){return dojox.gfx3d.matrix.multiplyPoint(d,t)});e=l[0],i=l[1],r=l[2],s=l[3],n=l[4],h=l[5],o=l[6],a=l[7],this.cache=[[e,i,r,s,e],[n,h,o,a,n],[e,s,a,n,e],[s,r,o,a,s],[r,i,h,o,r],[i,e,n,h,i]]},draw:function(t){this.cache=dojox.gfx3d.scheduler.bsp(this.cache,function(t){return t});var e=this.cache.slice(3);this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var o=0;o<e.length;o++)this.shape.createPolyline(e[o]).setStroke(this.strokeStyle).setFill(this.toStdFill(t,dojox.gfx3d.vector.normalize(e[o])))},getZOrder:function(){var t=this.cache[0][0],e=this.cache[1][2];return(t.z+e.z)/2}}),dojo.declare("dojox.gfx3d.Cylinder",dojox.gfx3d.Object,{constructor:function(){this.object=dojo.clone(dojox.gfx3d.defaultCylinder)},render:function(t){var e=dojox.gfx3d.matrix.multiply(t,this.matrix),o=[0,Math.PI/4,Math.PI/3],i=dojox.gfx3d.matrix.multiplyPoint(e,this.object.center),r=dojo.map(o,function(t){return{x:this.center.x+this.radius*Math.cos(t),y:this.center.y+this.radius*Math.sin(t),z:this.center.z}},this.object);r=dojo.map(r,function(t){return dojox.gfx3d.vector.substract(dojox.gfx3d.matrix.multiplyPoint(e,t),i)});var s={xx:r[0].x*r[0].y,xy:r[0].y*r[0].y,xz:1,yx:r[1].x*r[1].y,yy:r[1].y*r[1].y,yz:1,zx:r[2].x*r[2].y,zy:r[2].y*r[2].y,zz:1,dx:0,dy:0,dz:0},n=dojo.map(r,function(t){return-Math.pow(t.x,2)}),h=dojox.gfx3d.matrix.multiplyPoint(dojox.gfx3d.matrix.invert(s),n[0],n[1],n[2]),a=Math.atan2(h.x,1-h.y)/2,c=dojo.map(r,function(t){return dojox.gfx.matrix.multiplyPoint(dojox.gfx.matrix.rotate(-a),t.x,t.y)}),d=Math.pow(c[0].x,2),n=Math.pow(c[0].y,2),l=Math.pow(c[1].x,2),x=Math.pow(c[1].y,2),u=Math.sqrt((d*x-n*l)/(x-n)),f=Math.sqrt((d*x-n*l)/(d-l));if(f>u){var j=u;u=f,f=j,a-=Math.PI/2}var g=dojox.gfx3d.matrix.multiplyPoint(e,dojox.gfx3d.vector.sum(this.object.center,{x:0,y:0,z:this.object.height})),p="constant"==this.fillStyle.type?this.fillStyle.color:dojox.gfx3d.gradient(this.renderer.lighting,this.fillStyle,this.object.center,this.object.radius,Math.PI,2*Math.PI,e);(isNaN(u)||isNaN(f)||isNaN(a))&&(u=this.object.radius,f=0,a=0),this.cache={center:i,top:g,rx:u,ry:f,theta:a,gradient:p}},draw:function(){var t=this.cache,e=dojox.gfx3d.vector,o=dojox.gfx.matrix,i=[t.center,t.top],r=e.substract(t.top,t.center);e.dotProduct(r,this.renderer.lighting.incident)>0&&(i=[t.top,t.center],r=e.substract(t.center,t.top));var s=this.renderer.lighting[this.fillStyle.type](r,this.fillStyle.finish,this.fillStyle.color),n=Math.sqrt(Math.pow(t.center.x-t.top.x,2)+Math.pow(t.center.y-t.top.y,2));this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),this.shape.createPath("").moveTo(0,-t.rx).lineTo(n,-t.rx).lineTo(n,t.rx).lineTo(0,t.rx).arcTo(t.ry,t.rx,0,!0,!0,0,-t.rx).setFill(t.gradient).setStroke(this.strokeStyle).setTransform([o.translate(i[0]),o.rotate(Math.atan2(i[1].y-i[0].y,i[1].x-i[0].x))]),t.rx>0&&t.ry>0&&this.shape.createEllipse({cx:i[1].x,cy:i[1].y,rx:t.rx,ry:t.ry}).setFill(s).setStroke(this.strokeStyle).applyTransform(o.rotateAt(t.theta,i[1]))}}),dojo.declare("dojox.gfx3d.Viewport",dojox.gfx.Group,{constructor:function(){this.dimension=null,this.objects=[],this.todos=[],this.renderer=this,this.schedule=dojox.gfx3d.scheduler.zOrder,this.draw=dojox.gfx3d.drawer.conservative,this.deep=!1,this.lights=[],this.lighting=null},setCameraTransform:function(t){return this.camera=dojox.gfx3d.matrix.clone(t?dojox.gfx3d.matrix.normalize(t):dojox.gfx3d.identity,!0),this.invalidate(),this},applyCameraRightTransform:function(t){return t?this.setCameraTransform([this.camera,t]):this},applyCameraLeftTransform:function(t){return t?this.setCameraTransform([t,this.camera]):this},applyCameraTransform:function(t){return this.applyCameraRightTransform(t)},setLights:function(t,e,o){this.lights=t instanceof Array?{sources:t,ambient:e,specular:o}:t;var i={x:0,y:0,z:1};return this.lighting=new dojox.gfx3d.lighting.Model(i,this.lights.sources,this.lights.ambient,this.lights.specular),this.invalidate(),this},addLights:function(t){return this.setLights(this.lights.sources.concat(t))},addTodo:function(t){dojo.every(this.todos,function(e){return e!=t})&&this.todos.push(t)},invalidate:function(){this.deep=!0,this.todos=this.objects},setDimensions:function(t){this.dimension=t?{width:"string"==typeof t.width?parseInt(t.width):t.width,height:"string"==typeof t.height?parseInt(t.height):t.height}:null},render:function(){if(0!=this.todos.length){for(var t=dojox.gfx3d.matrix,e=0;e<this.todos.length;e++)this.todos[e].render(dojox.gfx3d.matrix.normalize([t.cameraRotateXg(180),t.cameraTranslate(0,this.dimension.height,0),this.camera]),this.deep);this.objects=this.schedule(this.objects),this.draw(this.todos,this.objects,this),this.todos=[],this.deep=!1}}}),dojox.gfx3d.Viewport.nodeType=dojox.gfx.Group.nodeType,dojox.gfx3d._creators={createEdges:function(t,e){return this.create3DObject(dojox.gfx3d.Edges,t,e)},createTriangles:function(t,e){return this.create3DObject(dojox.gfx3d.Triangles,t,e)},createQuads:function(t,e){return this.create3DObject(dojox.gfx3d.Quads,t,e)},createPolygon:function(t){return this.create3DObject(dojox.gfx3d.Polygon,t)},createOrbit:function(t){return this.create3DObject(dojox.gfx3d.Orbit,t)},createCube:function(t){return this.create3DObject(dojox.gfx3d.Cube,t)},createCylinder:function(t){return this.create3DObject(dojox.gfx3d.Cylinder,t)},createPath3d:function(t){return this.create3DObject(dojox.gfx3d.Path3d,t)},createScene:function(){return this.create3DObject(dojox.gfx3d.Scene)},create3DObject:function(t,e,o){var i=new t;return this.adopt(i),e&&i.setObject(e,o),i},adopt:function(t){return t.renderer=this.renderer,t.parent=this,this.objects.push(t),this.addTodo(t),this},abandon:function(t){for(var e=0;e<this.objects.length;++e)this.objects[e]==t&&this.objects.splice(e,1);return t.parent=null,this},setScheduler:function(t){this.schedule=t},setDrawer:function(t){this.draw=t}},dojo.extend(dojox.gfx3d.Viewport,dojox.gfx3d._creators),dojo.extend(dojox.gfx3d.Scene,dojox.gfx3d._creators),delete dojox.gfx3d._creators,dojo.extend(dojox.gfx.Surface,{createViewport:function(){var t=this.createObject(dojox.gfx3d.Viewport,null,!0);return t.setDimensions(this.getDimensions()),t}})}