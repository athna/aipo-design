dojo._xdResourceLoaded({depends:[["provide","dojox.data.XmlStore"],["provide","dojox.data.XmlItem"],["require","dojo.data.util.simpleFetch"],["require","dojo.data.util.filter"],["require","dojox.data.dom"]],defineResource:function(e){e._hasResource["dojox.data.XmlStore"]||(e._hasResource["dojox.data.XmlStore"]=!0,e.provide("dojox.data.XmlStore"),e.provide("dojox.data.XmlItem"),e.require("dojo.data.util.simpleFetch"),e.require("dojo.data.util.filter"),e.require("dojox.data.dom"),e.declare("dojox.data.XmlStore",null,{constructor:function(e){console.log("XmlStore()"),e&&(this._url=e.url,this._rootItem=e.rootItem||e.rootitem,this._keyAttribute=e.keyAttribute||e.keyattribute,this._attributeMap=e.attributeMap||e.attributemap,this._labelAttr=e.label,this._sendQuery=e.sendQuery||e.sendquery),this._newItems=[],this._deletedItems=[],this._modifiedItems=[]},getValue:function(e,t,r){var i=e.element;if("tagName"===t)return i.nodeName;if("childNodes"===t){for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(1===o.nodeType)return this._getItem(o)}return r}if("text()"===t){for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(3===o.nodeType||4===o.nodeType)return o.nodeValue}return r}if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1),a=i.getAttribute(s);return void 0!==a?a:r}for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(1===o.nodeType&&o.nodeName===t)return this._getItem(o)}return r},getValues:function(e,t){var r=e.element;if("tagName"===t)return[r.nodeName];if("childNodes"===t){for(var i=[],n=0;n<r.childNodes.length;n++){var o=r.childNodes[n];1===o.nodeType&&i.push(this._getItem(o))}return i}if("text()"===t){for(var i=[],n=0;n<r.childNodes.length;n++){var o=childNodes[n];3===o.nodeType&&i.push(o.nodeValue)}return i}if(t=this._getAttribute(r.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1),a=r.getAttribute(s);return void 0!==a?[a]:[]}for(var i=[],n=0;n<r.childNodes.length;n++){var o=r.childNodes[n];1===o.nodeType&&o.nodeName===t&&i.push(this._getItem(o))}return i},getAttributes:function(e){var t=e.element,r=[];if(r.push("tagName"),t.childNodes.length>0){for(var i={},n=!0,o=!1,s=0;s<t.childNodes.length;s++){var a=t.childNodes[s];if(1===a.nodeType){var l=a.nodeName;i[l]||(r.push(l),i[l]=l),n=!0}else 3===a.nodeType&&(o=!0)}n&&r.push("childNodes"),o&&r.push("text()")}for(var s=0;s<t.attributes.length;s++)r.push("@"+t.attributes[s].nodeName);if(this._attributeMap)for(var d in this._attributeMap){var s=d.indexOf(".");if(s>0){var h=d.substring(0,s);h===t.nodeName&&r.push(d.substring(s+1))}else r.push(d)}return r},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},containsValue:function(e,t,r){for(var i=this.getValues(e,t),n=0;n<i.length;n++)if("string"==typeof r){if(i[n].toString&&i[n].toString()===r)return!0}else if(i[n]===r)return!0;return!1},isItem:function(e){return e&&e.element&&e.store&&e.store===this?!0:!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(){},getFeatures:function(){var e={"dojo.data.api.Read":!0,"dojo.data.api.Write":!0};return e},getLabel:function(e){if(this._labelAttr&&this.isItem(e)){var t=this.getValue(e,this._labelAttr);if(t)return t.toString()}return void 0},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},_fetchItems:function(t,r,i){var n=this._getFetchUrl(t);if(console.log("XmlStore._fetchItems(): url="+n),!n)return i(new Error("No URL specified.")),void 0;var o=this._sendQuery?null:t,s=this,a={url:n,handleAs:"xml",preventCache:!0},l=e.xhrGet(a);l.addCallback(function(e){var i=s._getItems(e,o);console.log("XmlStore._fetchItems(): length="+(i?i.length:0)),i&&i.length>0?r(i,t):r([],t)}),l.addErrback(function(e){i(e,t)})},_getFetchUrl:function(t){if(!this._sendQuery)return this._url;var r=t.query;if(!r)return this._url;if(e.isString(r))return this._url+r;var i="";for(var n in r){var o=r[n];o&&(i&&(i+="&"),i+=n+"="+o)}if(!i)return this._url;var s=this._url;return s+=s.indexOf("?")<0?"?":"&",s+i},_getItems:function(t,r){var i=null;r&&(i=r.query);var n=[],o=null;o=this._rootItem?t.getElementsByTagName(this._rootItem):t.documentElement.childNodes;for(var s=0;s<o.length;s++){var a=o[s];if(1==a.nodeType){var l=this._getItem(a);if(i){var d=!0,h=r.queryOptions?r.queryOptions.ignoreCase:!1,u={};for(var m in i){var f=i[m];"string"==typeof f&&(u[m]=e.data.util.filter.patternToRegExp(f,h))}for(var c in i){var f=this.getValue(l,c);if(f){var _=i[c];if("string"==typeof f&&u[c]){if(null!==f.match(u[c]))continue}else if("object"==typeof f)if(f.toString&&u[c]){var g=f.toString();if(null!==g.match(u[c]))continue}else if("*"===_||_===f)continue}d=!1;break}if(!d)continue}n.push(l)}}return e.forEach(n,function(e){e.element.parentNode.removeChild(e.element)},this),n},close:function(){},newItem:function(e){console.log("XmlStore.newItem()"),e=e||{};var t=e.tagName;if(!t&&(t=this._rootItem,!t))return null;var r=this._getDocument(),i=r.createElement(t);for(var n in e)if("tagName"!==n)if("text()"===n){var o=r.createTextNode(e[n]);i.appendChild(o)}else if(n=this._getAttribute(t,n),"@"===n.charAt(0)){var s=n.substring(1);i.setAttribute(s,e[n])}else{var a=r.createElement(n),o=r.createTextNode(e[n]);a.appendChild(o),i.appendChild(a)}var l=this._getItem(i);return this._newItems.push(l),l},deleteItem:function(e){console.log("XmlStore.deleteItem()");var t=e.element;return t.parentNode?(this._backupItem(e),t.parentNode.removeChild(t),!0):(this._forgetItem(e),this._deletedItems.push(e),!0)},setValue:function(e,t,r){if("tagName"===t)return!1;this._backupItem(e);var i=e.element;if("childNodes"===t){var n=r.element;i.appendChild(n)}else if("text()"===t){for(;i.firstChild;)i.removeChild(i.firstChild);var o=this._getDocument(i).createTextNode(r);i.appendChild(o)}else if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1);i.setAttribute(s,r)}else{for(var n=null,a=0;a<i.childNodes.length;a++){var l=i.childNodes[a];if(1===l.nodeType&&l.nodeName===t){n=l;break}}var d=this._getDocument(i);if(n)for(;n.firstChild;)n.removeChild(n.firstChild);else n=d.createElement(t),i.appendChild(n);var o=d.createTextNode(r);n.appendChild(o)}return!0},setValues:function(e,t,r){if("tagName"===t)return!1;this._backupItem(e);var i=e.element;if("childNodes"===t){for(;i.firstChild;)i.removeChild(i.firstChild);for(var n=0;n<r.length;n++){var o=r[n].element;i.appendChild(o)}}else if("text()"===t){for(;i.firstChild;)i.removeChild(i.firstChild);for(var s="",n=0;n<r.length;n++)s+=r[n];var a=this._getDocument(i).createTextNode(s);i.appendChild(a)}else if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var l=t.substring(1);i.setAttribute(l,r[0])}else{for(var n=i.childNodes.length-1;n>=0;n--){var d=i.childNodes[n];1===d.nodeType&&d.nodeName===t&&i.removeChild(d)}for(var h=this._getDocument(i),n=0;n<r.length;n++){var o=h.createElement(t),a=h.createTextNode(r[n]);o.appendChild(a),i.appendChild(o)}}return!0},unsetAttribute:function(e,t){if("tagName"===t)return!1;this._backupItem(e);var r=e.element;if("childNodes"===t||"text()"===t)for(;r.firstChild;)r.removeChild(r.firstChild);else if(t=this._getAttribute(r.nodeName,t),"@"===t.charAt(0)){var i=t.substring(1);r.removeAttribute(i)}else for(var n=r.childNodes.length-1;n>=0;n--){var o=r.childNodes[n];1===o.nodeType&&o.nodeName===t&&r.removeChild(o)}return!0},save:function(e){e||(e={});for(var t=0;t<this._modifiedItems.length;t++)this._saveItem(this._modifiedItems[t],e,"PUT");for(var t=0;t<this._newItems.length;t++){var r=this._newItems[t];r.element.parentNode?(this._newItems.splice(t,1),t--):this._saveItem(this._newItems[t],e,"POST")}for(var t=0;t<this._deletedItems.length;t++)this._saveItem(this._deletedItems[t],e,"DELETE")},revert:function(){return console.log("XmlStore.revert() _newItems="+this._newItems.length),console.log("XmlStore.revert() _deletedItems="+this._deletedItems.length),console.log("XmlStore.revert() _modifiedItems="+this._modifiedItems.length),this._newItems=[],this._restoreItems(this._deletedItems),this._deletedItems=[],this._restoreItems(this._modifiedItems),this._modifiedItems=[],!0},isDirty:function(e){if(e){var t=this._getRootElement(e.element);return this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._deletedItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0}return this._newItems.length>0||this._deletedItems.length>0||this._modifiedItems.length>0},_saveItem:function(t,r,i){if(url="PUT"===i?this._getPutUrl(t):"DELETE"===i?this._getDeleteUrl(t):this._getPostUrl(t),!url)return r.onError&&r.onError.call(o,new Error("No URL for saving content: "+postContent)),void 0;var n={url:url,method:i||"POST",contentType:"text/xml",handleAs:"xml"};"PUT"===i?(n.putData=this._getPutContent(t),saveHandler=e.rawXhrPut(n)):"DELETE"===i?saveHandler=e.xhrDelete(n):(n.postData=this._getPostContent(t),saveHandler=e.rawXhrPost(n));var o=r.scope||e.global,s=this;saveHandler.addCallback(function(){s._forgetItem(t),r.onComplete&&r.onComplete.call(o)}),saveHandler.addErrback(function(e){r.onError&&r.onError.call(o,e)})},_getPostUrl:function(){return this._url},_getPutUrl:function(){return this._url},_getDeleteUrl:function(e){if(!this._url)return this._url;var t=this._url;if(e&&this._keyAttribute){var r=this.getValue(e,this._keyAttribute);r&&(t=t+"?"+this._keyAttribute+"="+r)}return t},_getPostContent:function(e){var t=e.element,r='<?xml version="1.0"?>';return r+dojox.data.dom.innerXML(t)},_getPutContent:function(e){var t=e.element,r='<?xml version="1.0"?>';return r+dojox.data.dom.innerXML(t)},_getAttribute:function(e,t){if(this._attributeMap){var r=e+"."+t,i=this._attributeMap[r];i?t=i:(i=this._attributeMap[t],i&&(t=i))}return t},_getItem:function(e){return new dojox.data.XmlItem(e,this)},_getItemIndex:function(e,t){for(var r=0;r<e.length;r++)if(e[r].element===t)return r;return-1},_backupItem:function(e){var t=this._getRootElement(e.element);this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0||(t!=e.element&&(e=this._getItem(t)),e._backup=t.cloneNode(!0),this._modifiedItems.push(e))},_restoreItems:function(t){e.forEach(t,function(e){e._backup&&(e.element=e._backup,e._backup=null)},this)},_forgetItem:function(e){var t=e.element,r=this._getItemIndex(this._newItems,t);r>=0&&this._newItems.splice(r,1),r=this._getItemIndex(this._deletedItems,t),r>=0&&this._deletedItems.splice(r,1),r=this._getItemIndex(this._modifiedItems,t),r>=0&&this._modifiedItems.splice(r,1)},_getDocument:function(e){return e?e.ownerDocument:this._document?void 0:dojox.data.dom.createDocument()},_getRootElement:function(e){for(;e.parentNode;)e=e.parentNode;return e}}),e.declare("dojox.data.XmlItem",null,{constructor:function(e,t){this.element=e,this.store=t},toString:function(){var e="";if(this.element)for(var t=0;t<this.element.childNodes.length;t++){var r=this.element.childNodes[t];if(3===r.nodeType){e=r.nodeValue;break}}return e}}),e.extend(dojox.data.XmlStore,e.data.util.simpleFetch))}});