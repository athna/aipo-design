dojo._hasResource["dojo.data.ItemFileReadStore"]||(dojo._hasResource["dojo.data.ItemFileReadStore"]=!0,dojo.provide("dojo.data.ItemFileReadStore"),dojo.require("dojo.data.util.filter"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.date.stamp"),dojo.declare("dojo.data.ItemFileReadStore",null,{constructor:function(t){this._arrayOfAllItems=[],this._arrayOfTopLevelItems=[],this._loadFinished=!1,this._jsonFileUrl=t.url,this._jsonData=t.data,this._datatypeMap=t.typeMap||{},this._datatypeMap.Date||(this._datatypeMap.Date={type:Date,deserialize:function(t){return dojo.date.stamp.fromISOString(t)}}),this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._itemsByIdentity=null,this._storeRefPropName="_S",this._itemNumPropName="_0",this._rootItemPropName="_RI",this._loadInProgress=!1,this._queuedFetches=[]},url:"",_assertIsItem:function(t){if(!this.isItem(t))throw new Error("dojo.data.ItemFileReadStore: Invalid item argument.")},_assertIsAttribute:function(t){if("string"!=typeof t)throw new Error("dojo.data.ItemFileReadStore: Invalid attribute argument.")},getValue:function(t,e,r){var a=this.getValues(t,e);return a.length>0?a[0]:r},getValues:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),t[e]||[]},getAttributes:function(t){this._assertIsItem(t);var e=[];for(var r in t)r!==this._storeRefPropName&&r!==this._itemNumPropName&&r!==this._rootItemPropName&&e.push(r);return e},hasAttribute:function(t,e){return this.getValues(t,e).length>0},containsValue:function(t,e,r){var a=void 0;return"string"==typeof r&&(a=dojo.data.util.filter.patternToRegExp(r,!1)),this._containsValue(t,e,r,a)},_containsValue:function(t,e,r,a){return dojo.some(this.getValues(t,e),function(t){if(null!==t&&!dojo.isObject(t)&&a){if(t.toString().match(a))return!0}else if(r===t)return!0})},isItem:function(t){return t&&t[this._storeRefPropName]===this&&this._arrayOfAllItems[t[this._itemNumPropName]]===t?!0:!1},isItemLoaded:function(t){return this.isItem(t)},loadItem:function(t){this._assertIsItem(t.item)},getFeatures:function(){return this._features},getLabel:function(t){return this._labelAttr&&this.isItem(t)?this.getValue(t,this._labelAttr):void 0},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},_fetchItems:function(t,e,r){var a=this,o=function(t,r){var o=[];if(t.query){var i=t.queryOptions?t.queryOptions.ignoreCase:!1,s={};for(var n in t.query){var l=t.query[n];"string"==typeof l&&(s[n]=dojo.data.util.filter.patternToRegExp(l,i))}for(var d=0;d<r.length;++d){var h=!0,u=r[d];if(null===u)h=!1;else for(var n in t.query){var l=t.query[n];a._containsValue(u,n,l,s[n])||(h=!1)}h&&o.push(u)}e(o,t)}else{for(var d=0;d<r.length;++d){var f=r[d];null!==f&&o.push(f)}e(o,t)}};if(this._loadFinished)o(t,this._getItemsArray(t.queryOptions));else if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:t,filter:o});else{this._loadInProgress=!0;var i={url:a._jsonFileUrl,handleAs:"json-comment-optional"},s=dojo.xhrGet(i);s.addCallback(function(e){try{a._getItemsFromLoadedData(e),a._loadFinished=!0,a._loadInProgress=!1,o(t,a._getItemsArray(t.queryOptions)),a._handleQueuedFetches()}catch(i){a._loadFinished=!0,a._loadInProgress=!1,r(i,t)}}),s.addErrback(function(e){a._loadInProgress=!1,r(e,t)})}else if(this._jsonData)try{this._loadFinished=!0,this._getItemsFromLoadedData(this._jsonData),this._jsonData=null,o(t,this._getItemsArray(t.queryOptions))}catch(n){r(n,t)}else r(new Error("dojo.data.ItemFileReadStore: No JSON source data was provided as either URL or a nested Javascript object."),t)},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var t=0;t<this._queuedFetches.length;t++){var e=this._queuedFetches[t],r=e.args,a=e.filter;a?a(r,this._getItemsArray(r.queryOptions)):this.fetchItemByIdentity(r)}this._queuedFetches=[]}},_getItemsArray:function(t){return t&&t.deep?this._arrayOfAllItems:this._arrayOfTopLevelItems},close:function(){},_getItemsFromLoadedData:function(t){function e(t){var e=null!=t&&"object"==typeof t&&!dojo.isArray(t)&&!dojo.isFunction(t)&&t.constructor==Object&&"undefined"==typeof t._reference&&"undefined"==typeof t._type&&"undefined"==typeof t._value;return e}function r(t){a._arrayOfAllItems.push(t);for(var o in t){var i=t[o];if(i)if(dojo.isArray(i))for(var s=i,n=0;n<s.length;++n){var l=s[n];e(l)&&r(l)}else e(i)&&r(i)}}var a=this;this._labelAttr=t.label;var o,i;for(this._arrayOfAllItems=[],this._arrayOfTopLevelItems=t.items,o=0;o<this._arrayOfTopLevelItems.length;++o)i=this._arrayOfTopLevelItems[o],r(i),i[this._rootItemPropName]=!0;var s,n={};for(o=0;o<this._arrayOfAllItems.length;++o){i=this._arrayOfAllItems[o];for(s in i){if(s!==this._rootItemPropName){var l=i[s];null!==l?dojo.isArray(l)||(i[s]=[l]):i[s]=[null]}n[s]=s}}for(;n[this._storeRefPropName];)this._storeRefPropName+="_";for(;n[this._itemNumPropName];)this._itemNumPropName+="_";var d,h=t.identifier;if(h)for(this._itemsByIdentity={},this._features["dojo.data.api.Identity"]=h,o=0;o<this._arrayOfAllItems.length;++o){i=this._arrayOfAllItems[o],d=i[h];var u=d[0];if(this._itemsByIdentity[u]){if(this._jsonFileUrl)throw new Error("dojo.data.ItemFileReadStore:  The json data as specified by: ["+this._jsonFileUrl+"] is malformed.  Items within the list have identifier: ["+h+"].  Value collided: ["+u+"]");if(this._jsonData)throw new Error("dojo.data.ItemFileReadStore:  The json data provided by the creation arguments is malformed.  Items within the list have identifier: ["+h+"].  Value collided: ["+u+"]")}else this._itemsByIdentity[u]=i}else this._features["dojo.data.api.Identity"]=Number;for(o=0;o<this._arrayOfAllItems.length;++o)i=this._arrayOfAllItems[o],i[this._storeRefPropName]=this,i[this._itemNumPropName]=o;for(o=0;o<this._arrayOfAllItems.length;++o){i=this._arrayOfAllItems[o];for(s in i){d=i[s];for(var f=0;f<d.length;++f)if(l=d[f],null!==l&&"object"==typeof l){if(l._type&&l._value){var _=l._type,m=this._datatypeMap[_];if(!m)throw new Error("dojo.data.ItemFileReadStore: in the typeMap constructor arg, no object class was specified for the datatype '"+_+"'");if(dojo.isFunction(m))d[f]=new m(l._value);else{if(!dojo.isFunction(m.deserialize))throw new Error("dojo.data.ItemFileReadStore: Value provided in typeMap was neither a constructor, nor a an object with a deserialize function");d[f]=m.deserialize(l._value)}}if(l._reference){var c=l._reference;if(dojo.isString(c))d[f]=this._itemsByIdentity[c];else for(var I=0;I<this._arrayOfAllItems.length;++I){var y=this._arrayOfAllItems[I],p=!0;for(var j in c)y[j]!=c[j]&&(p=!1);p&&(d[f]=y)}}}}}},getIdentity:function(t){var e=this._features["dojo.data.api.Identity"];if(e===Number)return t[this._itemNumPropName];var r=t[e];return r?r[0]:null},fetchItemByIdentity:function(t){if(this._loadFinished){var e=this._getItemByIdentity(t.identity);if(t.onItem){var r=t.scope?t.scope:dojo.global;t.onItem.call(r,e)}}else{var a=this;if(this._jsonFileUrl)if(this._loadInProgress)this._queuedFetches.push({args:t});else{this._loadInProgress=!0;var o={url:a._jsonFileUrl,handleAs:"json-comment-optional"},i=dojo.xhrGet(o);i.addCallback(function(e){var r=t.scope?t.scope:dojo.global;try{a._getItemsFromLoadedData(e),a._loadFinished=!0,a._loadInProgress=!1;var o=a._getItemByIdentity(t.identity);t.onItem&&t.onItem.call(r,o),a._handleQueuedFetches()}catch(i){a._loadInProgress=!1,t.onError&&t.onError.call(r,i)}}),i.addErrback(function(e){if(a._loadInProgress=!1,t.onError){var r=t.scope?t.scope:dojo.global;t.onError.call(r,e)}})}else if(this._jsonData){a._getItemsFromLoadedData(a._jsonData),a._jsonData=null,a._loadFinished=!0;var e=a._getItemByIdentity(t.identity);if(t.onItem){var r=t.scope?t.scope:dojo.global;t.onItem.call(r,e)}}}},_getItemByIdentity:function(t){var e=null;return e=this._itemsByIdentity?this._itemsByIdentity[t]:this._arrayOfAllItems[t],void 0===e&&(e=null),e},getIdentityAttributes:function(){var t=this._features["dojo.data.api.Identity"];return t===Number?null:[t]},_forceLoad:function(){var t=this;if(this._jsonFileUrl){var e={url:t._jsonFileUrl,handleAs:"json-comment-optional",sync:!0},r=dojo.xhrGet(e);r.addCallback(function(e){try{t._loadInProgress===!0||t._loadFinished||(t._getItemsFromLoadedData(e),t._loadFinished=!0)}catch(r){throw console.log(r),r}}),r.addErrback(function(t){throw t})}else this._jsonData&&(t._getItemsFromLoadedData(t._jsonData),t._jsonData=null,t._loadFinished=!0)}}),dojo.extend(dojo.data.ItemFileReadStore,dojo.data.util.simpleFetch));