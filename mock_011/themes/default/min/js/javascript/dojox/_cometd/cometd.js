dojo._hasResource["dojox._cometd.cometd"]||(dojo._hasResource["dojox._cometd.cometd"]=!0,dojo.provide("dojox._cometd.cometd"),dojo.require("dojo.AdapterRegistry"),dojo.require("dojo.io.script"),dojox.cometd=new function(){this._initialized=!1,this._connected=!1,this._polling=!1,this.connectionTypes=new dojo.AdapterRegistry(!0),this.version="1.0",this.minimumVersion="0.9",this.clientId=null,this.messageId=0,this.batch=0,this._isXD=!1,this.handshakeReturn=null,this.currentTransport=null,this.url=null,this.lastMessage=null,this.topics={},this._messageQ=[],this.handleAs="json-comment-optional",this.advice,this.pendingSubscriptions={},this.pendingUnsubscriptions={},this._subscriptions=[],this.tunnelInit=function(){},this.tunnelCollapse=function(){console.debug("tunnel collapsed!")},this.init=function(t,i,e){if(i=i||{},i.version=this.version,i.minimumVersion=this.minimumVersion,i.channel="/meta/handshake",i.id=""+this.messageId++,this.url=t||djConfig.cometdRoot,!this.url)return console.debug("no cometd root specified in djConfig and no root passed"),void 0;var n="^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$",s=(""+window.location).match(new RegExp(n));if(s[4]){var o=s[4].split(":"),c=o[0],d=o[1]||"80";if(s=this.url.match(new RegExp(n)),s[4]){o=s[4].split(":");var h=o[0],r=o[1]||"80";this._isXD=h!=c||r!=d}}this._isXD||(i.ext?i.ext["json-comment-filtered"]!==!0&&i.ext["json-comment-filtered"]!==!1&&(i.ext["json-comment-filtered"]=!0):i.ext={"json-comment-filtered":!0});var l={url:this.url,handleAs:this.handleAs,content:{message:dojo.toJson([i])},load:dojo.hitch(this,"finishInit"),error:function(t){console.debug("handshake error!:",t)}};return e&&dojo.mixin(l,e),this._props=i,this._initialized=!0,this.batch=0,this.startBatch(),this._isXD?(l.callbackParamName="jsonp",dojo.io.script.get(l)):dojo.xhrPost(l)},this.finishInit=function(t){if(t=t[0],this.handshakeReturn=t,t.advice&&(this.advice=t.advice),t.successful){if(t.version<this.minimumVersion)return console.debug("cometd protocol version mismatch. We wanted",this.minimumVersion,"but got",t.version),void 0;this.currentTransport=this.connectionTypes.match(t.supportedConnectionTypes,t.version,this._isXD),this.currentTransport._cometd=this,this.currentTransport.version=t.version,this.clientId=t.clientId,this.tunnelInit=dojo.hitch(this.currentTransport,"tunnelInit"),this.tunnelCollapse=dojo.hitch(this.currentTransport,"tunnelCollapse"),this.currentTransport.startup(t)}else{if(console.debug("cometd init failed"),this.advice&&"none"==this.advice.reconnect)return;if(this.advice&&this.advice.interval&&this.advice.interval>0){var i=this;setTimeout(function(){i.init(i.url,i._props)},this.advice.interval)}else this.init(this.url,this._props)}},this.deliver=function(t){return dojo.forEach(t,this._deliver,this),t},this._deliver=function(t){if(!t.channel&&t.success!==!0)return console.debug("cometd error: no channel for message!",t),void 0;if(this.lastMessage=t,t.advice&&(this.advice=t.advice),t.channel&&t.channel.length>5&&"/meta"==t.channel.substr(0,5))switch(t.channel){case"/meta/connect":t.successful&&!this._connected?(this._connected=this._initialized,this.endBatch()):this._initialized||(this._connected=!1);break;case"/meta/subscribe":var i=this.pendingSubscriptions[t.subscription];if(!t.successful)return i&&(i.errback(new Error(t.error)),delete this.pendingSubscriptions[t.subscription]),void 0;dojox.cometd.subscribed(t.subscription,t),i&&(i.callback(!0),delete this.pendingSubscriptions[t.subscription]);break;case"/meta/unsubscribe":var i=this.pendingUnsubscriptions[t.subscription];if(!t.successful)return i&&(i.errback(new Error(t.error)),delete this.pendingUnsubscriptions[t.subscription]),void 0;this.unsubscribed(t.subscription,t),i&&(i.callback(!0),delete this.pendingUnsubscriptions[t.subscription])}if(this.currentTransport.deliver(t),t.data){var e="/cometd"+t.channel;dojo.publish(e,[t])}},this.disconnect=function(){dojo.forEach(this._subscriptions,dojo.unsubscribe),this._subscriptions=[],this._messageQ=[],this._initialized&&this.currentTransport&&(this._initialized=!1,this.currentTransport.disconnect()),this._initialized=!1,this._polling||(this._connected=!1)},this.publish=function(t,i,e){var n={data:i,channel:t};e&&dojo.mixin(n,e),this._sendMessage(n)},this._sendMessage=function(t){return this.currentTransport&&this._connected&&0==this.batch?this.currentTransport.sendMessages([t]):(this._messageQ.push(t),void 0)},this.subscribe=function(t,i,e){if(this.pendingSubscriptions[t]){var n=this.pendingSubscriptions[t];n.cancel(),delete this.pendingSubscriptions[t]}var s=new dojo.Deferred;if(this.pendingSubscriptions[t]=s,i){var o="/cometd"+t;this.topics[o]&&dojo.unsubscribe(this.topics[o]);var c=dojo.subscribe(o,i,e);this.topics[o]=c}return this._sendMessage({channel:"/meta/subscribe",subscription:t}),s},this.subscribed=function(){},this.unsubscribe=function(t){if(this.pendingUnsubscriptions[t]){var i=this.pendingUnsubscriptions[t];i.cancel(),delete this.pendingUnsubscriptions[t]}var e=new dojo.Deferred;this.pendingUnsubscriptions[t]=e;var n="/cometd"+t;return this.topics[n]&&dojo.unsubscribe(this.topics[n]),this._sendMessage({channel:"/meta/unsubscribe",subscription:t}),e},this.unsubscribed=function(){},this.startBatch=function(){this.batch++},this.endBatch=function(){if(--this.batch<=0&&this.currentTransport&&this._connected){this.batch=0;var t=this._messageQ;this._messageQ=[],t.length>0&&this.currentTransport.sendMessages(t)}},this._onUnload=function(){dojo.addOnUnload(dojox.cometd,"disconnect")}},dojox.cometd.longPollTransport=new function(){this._connectionType="long-polling",this._cometd=null,this.lastTimestamp=null,this.check=function(t,i,e){return!e&&dojo.indexOf(t,"long-polling")>=0},this.tunnelInit=function(){this._cometd._polling||this.openTunnelWith({message:dojo.toJson([{channel:"/meta/connect",clientId:this._cometd.clientId,connectionType:this._connectionType,id:""+this._cometd.messageId++}])})},this.tunnelCollapse=function(){if(!this._cometd._polling)if(this._cometd._polling=!1,this._cometd.advice){if("none"==this._cometd.advice.reconnect)return;if(this._cometd.advice.interval&&this._cometd.advice.interval>0){var t=this;setTimeout(function(){t._connect()},this._cometd.advice.interval)}else this._connect()}else this._connect()},this._connect=function(){this._cometd.advice&&"handshake"==this._cometd.advice.reconnect?this._cometd.init(this._cometd.url,this._cometd._props):this._cometd._connected&&this.openTunnelWith({message:dojo.toJson([{channel:"/meta/connect",connectionType:this._connectionType,clientId:this._cometd.clientId,timestamp:this.lastTimestamp,id:""+this._cometd.messageId++}])})},this.deliver=function(t){t.timestamp&&(this.lastTimestamp=t.timestamp)},this.openTunnelWith=function(t,i){dojo.xhrPost({url:i||this._cometd.url,content:t,handleAs:this._cometd.handleAs,load:dojo.hitch(this,function(t){this._cometd._polling=!1,this._cometd.deliver(t),this.tunnelCollapse()}),error:function(t){console.debug("tunnel opening failed:",t),dojo.cometd._polling=!1}});this._cometd._polling=!0},this.sendMessages=function(t){for(var i=0;i<t.length;i++)t[i].clientId=this._cometd.clientId,t[i].id=""+this._cometd.messageId++;return dojo.xhrPost({url:this._cometd.url||djConfig.cometdRoot,handleAs:this._cometd.handleAs,load:dojo.hitch(this._cometd,"deliver"),content:{message:dojo.toJson(t)}})},this.startup=function(){this._cometd._connected||this.tunnelInit()},this.disconnect=function(){dojo.xhrPost({url:this._cometd.url||djConfig.cometdRoot,handleAs:this._cometd.handleAs,content:{message:dojo.toJson([{channel:"/meta/disconnect",clientId:this._cometd.clientId,id:""+this._cometd.messageId++}])}})}},dojox.cometd.callbackPollTransport=new function(){this._connectionType="callback-polling",this._cometd=null,this.lastTimestamp=null,this.check=function(t){return dojo.indexOf(t,"callback-polling")>=0},this.tunnelInit=function(){this._cometd._polling||this.openTunnelWith({message:dojo.toJson([{channel:"/meta/connect",clientId:this._cometd.clientId,connectionType:this._connectionType,id:""+this._cometd.messageId++}])})},this.tunnelCollapse=dojox.cometd.longPollTransport.tunnelCollapse,this._connect=dojox.cometd.longPollTransport._connect,this.deliver=dojox.cometd.longPollTransport.deliver,this.openTunnelWith=function(t,i){dojo.io.script.get({load:dojo.hitch(this,function(t){this._cometd._polling=!1,this._cometd.deliver(t),this.tunnelCollapse()}),error:function(){this._cometd._polling=!1,console.debug("tunnel opening failed")},url:i||this._cometd.url,content:t,callbackParamName:"jsonp"}),this._cometd._polling=!0},this.sendMessages=function(t){for(var i=0;i<t.length;i++)t[i].clientId=this._cometd.clientId,t[i].id=""+this._cometd.messageId++;var e={url:this._cometd.url||djConfig.cometdRoot,load:dojo.hitch(this._cometd,"deliver"),callbackParamName:"jsonp",content:{message:dojo.toJson(t)}};return dojo.io.script.get(e)},this.startup=function(){this._cometd._connected||this.tunnelInit()},this.disconnect=dojox.cometd.longPollTransport.disconnect,this.disconnect=function(){dojo.io.script.get({url:this._cometd.url||djConfig.cometdRoot,callbackParamName:"jsonp",content:{message:dojo.toJson([{channel:"/meta/disconnect",clientId:this._cometd.clientId,id:""+this._cometd.messageId++}])}})}},dojox.cometd.connectionTypes.register("long-polling",dojox.cometd.longPollTransport.check,dojox.cometd.longPollTransport),dojox.cometd.connectionTypes.register("callback-polling",dojox.cometd.callbackPollTransport.check,dojox.cometd.callbackPollTransport),dojo.addOnUnload(dojox.cometd,"_onUnload"));