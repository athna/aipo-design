dojo._hasResource["dojox.data.FlickrRestStore"]||(dojo._hasResource["dojox.data.FlickrRestStore"]=!0,dojo.provide("dojox.data.FlickrRestStore"),dojo.require("dojox.data.FlickrStore"),dojo.declare("dojox.data.FlickrRestStore",dojox.data.FlickrStore,{constructor:function(t){t&&t.label&&(t.label&&(this.label=t.label),t.apikey&&(this._apikey=t.apikey)),this._cache=[],this._prevRequests={},this._handlers={},this._prevRequestRanges=[],this._maxPhotosPerUser={},this._id=dojox.data.FlickrRestStore.prototype._id++},_id:0,_requestCount:0,_flickrRestUrl:"http://www.flickr.com/services/rest/",_apikey:null,_storeRef:"_S",_cache:null,_prevRequests:null,_handlers:null,_sortAttributes:{"date-posted":!0,"date-taken":!0,interestingness:!0},_fetchItems:function(t,e,r){var a={};t.query?dojo.mixin(a,t.query):t.query=a={};var s=[],o=[],n="FlickrRestStoreCallback_"+this._id+"_"+ ++this._requestCount,i={format:"json",method:"flickr.photos.search",api_key:this._apikey,extras:"owner_name,date_upload,date_taken",jsoncallback:n},u=!1;if(a.userid&&(u=!0,i.user_id=t.query.userid,s.push("userid"+t.query.userid)),!a.apikey)throw Error("dojox.data.FlickrRestStore: An API key must be specified.");if(u=!0,i.api_key=t.query.apikey,o.push("api"+t.query.apikey),t._curCount=t.count,a.page)i.page=t.query.page,o.push("page"+i.page);else if("undefined"!=typeof t.start&&null!=t.start){t.count||(t.count=20);var l=t.start%t.count,h=t.start,d=t.count;if(0!=l){if(d/2>h)d=h+d,h=0;else{for(var c=20,p=2,_=c;_>0;_--)if(h%_==0&&h/_>=d){p=_;break}d=h/p}t._realStart=t.start,t._realCount=t.count,t._curStart=h,t._curCount=d}else t._realStart=t._realCount=null,t._curStart=t.start,t._curCount=t.count;i.page=h/d+1,o.push("page"+i.page)}t._curCount&&(i.per_page=t._curCount,o.push("count"+t._curCount)),a.lang&&(i.lang=t.query.lang,s.push("lang"+t.lang));this._flickrRestUrl;a.setid&&(i.method="flickr.photosets.getPhotos",i.photoset_id=t.query.set,s.push("set"+t.query.set)),a.tags&&(i.tags=a.tags instanceof Array?a.tags.join(","):a.tags,s.push("tags"+i.tags),!a.tag_mode||"any"!=a.tag_mode.toLowerCase()&&"all"!=a.tag_mode.toLowerCase()||(i.tag_mode=a.tag_mode)),a.text&&(i.text=a.text,s.push("text:"+a.text)),a.sort&&a.sort.length>0?(a.sort[0].attribute||(a.sort[0].attribute="date-posted"),this._sortAttributes[a.sort[0].attribute]&&(i.sort=a.sort[0].descending?a.sort[0].attribute+"-desc":a.sort[0].attribute+"-asc")):i.sort="date-posted-asc",s.push("sort:"+i.sort),s=s.join("."),o=o.length>0?"."+o.join("."):"";var g=s+o;t={query:a,count:t._curCount,start:t._curStart,_realCount:t._realCount,_realStart:t._realStart,onBegin:t.onBegin,onComplete:t.onComplete,onItem:t.onItem};var f={request:t,fetchHandler:e,errorHandler:r};if(this._handlers[g])return this._handlers[g].push(f),void 0;this._handlers[g]=[f];var m=this,k=null,v={url:this._flickrRestUrl,preventCache:!0,content:i},q=function(t,e,r){var a=r.request.onBegin;r.request.onBegin=null;var o,n=r.request;void 0!=typeof n._realStart&&null!=n._realStart&&(n.start=n._realStart,n.count=n._realCount,n._realStart=n._realCount=null),a&&(e&&"undefined"!=typeof e.photos.perpage&&"undefined"!=typeof e.photos.pages?(o=e.photos.perpage*e.photos.pages<=r.request.start+r.request.count?r.request.start+e.photos.photo.length:e.photos.perpage*e.photos.pages,m._maxPhotosPerUser[s]=o,a(o,r.request)):m._maxPhotosPerUser[s]&&a(m._maxPhotosPerUser[s],r.request)),r.fetchHandler(t,r.request),a&&(r.request.onBegin=a)},y=function(e){if("ok"!=e.stat)r(null,t);else{var a=m._handlers[g];if(!a)return console.log("FlickrRestStore: no handlers for data",e),void 0;m._handlers[g]=null,m._prevRequests[g]=e;var o=m._processFlickrData(e,t,s);m._prevRequestRanges[s]||(m._prevRequestRanges[s]=[]),m._prevRequestRanges[s].push({start:t.start,end:t.start+e.photos.photo.length});for(var n=0;n<a.length;n++)q(o,e,a[n])}},R=this._prevRequests[g];if(R)return this._handlers[g]=null,q(this._cache[s],R,f),void 0;if(this._checkPrevRanges(s,t.start,t.count))return this._handlers[g]=null,q(this._cache[s],null,f),void 0;dojo.global[n]=function(t){y(t),dojo.global[n]=null};var j=dojo.io.script.get(v);j.addErrback(function(e){dojo.disconnect(k),r(e,t)})},getAttributes:function(){return["title","author","imageUrl","imageUrlSmall","imageUrlMedium","imageUrlThumb","link","dateTaken","datePublished"]},getValues:function(t,e){return this._assertIsItem(t),this._assertIsAttribute(e),"title"===e?[this._unescapeHtml(t.title)]:"author"===e?[t.ownername]:"imageUrlSmall"===e?[t.media.s]:"imageUrl"===e?[t.media.l]:"imageUrlMedium"===e?[t.media.m]:"imageUrlThumb"===e?[t.media.t]:"link"===e?["http://www.flickr.com/photos/"+t.owner+"/"+t.id]:"dateTaken"===e?t.datetaken:"datePublished"===e?t.datepublished:void 0},_processFlickrData:function(t,e,r){if(t.items)return dojox.data.FlickrStore.prototype._processFlickrData.apply(this,arguments);var a=["http://farm",null,".static.flickr.com/",null,"/",null,"_",null],s=[];if("ok"==t.stat&&t.photos&&t.photos.photo){s=t.photos.photo;for(var o=0;o<s.length;o++){var n=s[o];n[this._storeRef]=this,a[1]=n.farm,a[3]=n.server,a[5]=n.id,a[7]=n.secret;var i=a.join("");n.media={s:i+"_s.jpg",m:i+"_m.jpg",l:i+".jpg",t:i+"_t.jpg"}}}var u=e.start?e.start:0,l=this._cache[r];l||(this._cache[r]=l=[]);for(var h=0;h<s.length;h++)l[h+u]=s[h];return l},_checkPrevRanges:function(t,e,r){var a=e+r,s=this._prevRequestRanges[t];if(!s)return!1;for(var o=0;o<s.length;o++)if(e>=s[o].start&&a<=s[o].end)return!0;return!1}}));