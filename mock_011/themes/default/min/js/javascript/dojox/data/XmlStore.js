dojo._hasResource["dojox.data.XmlStore"]||(dojo._hasResource["dojox.data.XmlStore"]=!0,dojo.provide("dojox.data.XmlStore"),dojo.provide("dojox.data.XmlItem"),dojo.require("dojo.data.util.simpleFetch"),dojo.require("dojo.data.util.filter"),dojo.require("dojox.data.dom"),dojo.declare("dojox.data.XmlStore",null,{constructor:function(e){console.log("XmlStore()"),e&&(this._url=e.url,this._rootItem=e.rootItem||e.rootitem,this._keyAttribute=e.keyAttribute||e.keyattribute,this._attributeMap=e.attributeMap||e.attributemap,this._labelAttr=e.label,this._sendQuery=e.sendQuery||e.sendquery),this._newItems=[],this._deletedItems=[],this._modifiedItems=[]},getValue:function(e,t,r){var i=e.element;if("tagName"===t)return i.nodeName;if("childNodes"===t){for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(1===o.nodeType)return this._getItem(o)}return r}if("text()"===t){for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(3===o.nodeType||4===o.nodeType)return o.nodeValue}return r}if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1),l=i.getAttribute(s);return void 0!==l?l:r}for(var n=0;n<i.childNodes.length;n++){var o=i.childNodes[n];if(1===o.nodeType&&o.nodeName===t)return this._getItem(o)}return r},getValues:function(e,t){var r=e.element;if("tagName"===t)return[r.nodeName];if("childNodes"===t){for(var i=[],n=0;n<r.childNodes.length;n++){var o=r.childNodes[n];1===o.nodeType&&i.push(this._getItem(o))}return i}if("text()"===t){for(var i=[],n=0;n<r.childNodes.length;n++){var o=childNodes[n];3===o.nodeType&&i.push(o.nodeValue)}return i}if(t=this._getAttribute(r.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1),l=r.getAttribute(s);return void 0!==l?[l]:[]}for(var i=[],n=0;n<r.childNodes.length;n++){var o=r.childNodes[n];1===o.nodeType&&o.nodeName===t&&i.push(this._getItem(o))}return i},getAttributes:function(e){var t=e.element,r=[];if(r.push("tagName"),t.childNodes.length>0){for(var i={},n=!0,o=!1,s=0;s<t.childNodes.length;s++){var l=t.childNodes[s];if(1===l.nodeType){var a=l.nodeName;i[a]||(r.push(a),i[a]=a),n=!0}else 3===l.nodeType&&(o=!0)}n&&r.push("childNodes"),o&&r.push("text()")}for(var s=0;s<t.attributes.length;s++)r.push("@"+t.attributes[s].nodeName);if(this._attributeMap)for(var d in this._attributeMap){var s=d.indexOf(".");if(s>0){var h=d.substring(0,s);h===t.nodeName&&r.push(d.substring(s+1))}else r.push(d)}return r},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},containsValue:function(e,t,r){for(var i=this.getValues(e,t),n=0;n<i.length;n++)if("string"==typeof r){if(i[n].toString&&i[n].toString()===r)return!0}else if(i[n]===r)return!0;return!1},isItem:function(e){return e&&e.element&&e.store&&e.store===this?!0:!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(){},getFeatures:function(){var e={"dojo.data.api.Read":!0,"dojo.data.api.Write":!0};return e},getLabel:function(e){if(this._labelAttr&&this.isItem(e)){var t=this.getValue(e,this._labelAttr);if(t)return t.toString()}return void 0},getLabelAttributes:function(){return this._labelAttr?[this._labelAttr]:null},_fetchItems:function(e,t,r){var i=this._getFetchUrl(e);if(console.log("XmlStore._fetchItems(): url="+i),!i)return r(new Error("No URL specified.")),void 0;var n=this._sendQuery?null:e,o=this,s={url:i,handleAs:"xml",preventCache:!0},l=dojo.xhrGet(s);l.addCallback(function(r){var i=o._getItems(r,n);console.log("XmlStore._fetchItems(): length="+(i?i.length:0)),i&&i.length>0?t(i,e):t([],e)}),l.addErrback(function(t){r(t,e)})},_getFetchUrl:function(e){if(!this._sendQuery)return this._url;var t=e.query;if(!t)return this._url;if(dojo.isString(t))return this._url+t;var r="";for(var i in t){var n=t[i];n&&(r&&(r+="&"),r+=i+"="+n)}if(!r)return this._url;var o=this._url;return o+=o.indexOf("?")<0?"?":"&",o+r},_getItems:function(e,t){var r=null;t&&(r=t.query);var i=[],n=null;n=this._rootItem?e.getElementsByTagName(this._rootItem):e.documentElement.childNodes;for(var o=0;o<n.length;o++){var s=n[o];if(1==s.nodeType){var l=this._getItem(s);if(r){var a=!0,d=t.queryOptions?t.queryOptions.ignoreCase:!1,h={};for(var u in r){var m=r[u];"string"==typeof m&&(h[u]=dojo.data.util.filter.patternToRegExp(m,d))}for(var f in r){var m=this.getValue(l,f);if(m){var c=r[f];if("string"==typeof m&&h[f]){if(null!==m.match(h[f]))continue}else if("object"==typeof m)if(m.toString&&h[f]){var _=m.toString();if(null!==_.match(h[f]))continue}else if("*"===c||c===m)continue}a=!1;break}if(!a)continue}i.push(l)}}return dojo.forEach(i,function(e){e.element.parentNode.removeChild(e.element)},this),i},close:function(){},newItem:function(e){console.log("XmlStore.newItem()"),e=e||{};var t=e.tagName;if(!t&&(t=this._rootItem,!t))return null;var r=this._getDocument(),i=r.createElement(t);for(var n in e)if("tagName"!==n)if("text()"===n){var o=r.createTextNode(e[n]);i.appendChild(o)}else if(n=this._getAttribute(t,n),"@"===n.charAt(0)){var s=n.substring(1);i.setAttribute(s,e[n])}else{var l=r.createElement(n),o=r.createTextNode(e[n]);l.appendChild(o),i.appendChild(l)}var a=this._getItem(i);return this._newItems.push(a),a},deleteItem:function(e){console.log("XmlStore.deleteItem()");var t=e.element;return t.parentNode?(this._backupItem(e),t.parentNode.removeChild(t),!0):(this._forgetItem(e),this._deletedItems.push(e),!0)},setValue:function(e,t,r){if("tagName"===t)return!1;this._backupItem(e);var i=e.element;if("childNodes"===t){var n=r.element;i.appendChild(n)}else if("text()"===t){for(;i.firstChild;)i.removeChild(i.firstChild);var o=this._getDocument(i).createTextNode(r);i.appendChild(o)}else if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1);i.setAttribute(s,r)}else{for(var n=null,l=0;l<i.childNodes.length;l++){var a=i.childNodes[l];if(1===a.nodeType&&a.nodeName===t){n=a;break}}var d=this._getDocument(i);if(n)for(;n.firstChild;)n.removeChild(n.firstChild);else n=d.createElement(t),i.appendChild(n);var o=d.createTextNode(r);n.appendChild(o)}return!0},setValues:function(e,t,r){if("tagName"===t)return!1;this._backupItem(e);var i=e.element;if("childNodes"===t){for(;i.firstChild;)i.removeChild(i.firstChild);for(var n=0;n<r.length;n++){var o=r[n].element;i.appendChild(o)}}else if("text()"===t){for(;i.firstChild;)i.removeChild(i.firstChild);for(var s="",n=0;n<r.length;n++)s+=r[n];var l=this._getDocument(i).createTextNode(s);i.appendChild(l)}else if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var a=t.substring(1);i.setAttribute(a,r[0])}else{for(var n=i.childNodes.length-1;n>=0;n--){var d=i.childNodes[n];1===d.nodeType&&d.nodeName===t&&i.removeChild(d)}for(var h=this._getDocument(i),n=0;n<r.length;n++){var o=h.createElement(t),l=h.createTextNode(r[n]);o.appendChild(l),i.appendChild(o)}}return!0},unsetAttribute:function(e,t){if("tagName"===t)return!1;this._backupItem(e);var r=e.element;if("childNodes"===t||"text()"===t)for(;r.firstChild;)r.removeChild(r.firstChild);else if(t=this._getAttribute(r.nodeName,t),"@"===t.charAt(0)){var i=t.substring(1);r.removeAttribute(i)}else for(var n=r.childNodes.length-1;n>=0;n--){var o=r.childNodes[n];1===o.nodeType&&o.nodeName===t&&r.removeChild(o)}return!0},save:function(e){e||(e={});for(var t=0;t<this._modifiedItems.length;t++)this._saveItem(this._modifiedItems[t],e,"PUT");for(var t=0;t<this._newItems.length;t++){var r=this._newItems[t];r.element.parentNode?(this._newItems.splice(t,1),t--):this._saveItem(this._newItems[t],e,"POST")}for(var t=0;t<this._deletedItems.length;t++)this._saveItem(this._deletedItems[t],e,"DELETE")},revert:function(){return console.log("XmlStore.revert() _newItems="+this._newItems.length),console.log("XmlStore.revert() _deletedItems="+this._deletedItems.length),console.log("XmlStore.revert() _modifiedItems="+this._modifiedItems.length),this._newItems=[],this._restoreItems(this._deletedItems),this._deletedItems=[],this._restoreItems(this._modifiedItems),this._modifiedItems=[],!0},isDirty:function(e){if(e){var t=this._getRootElement(e.element);return this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._deletedItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0}return this._newItems.length>0||this._deletedItems.length>0||this._modifiedItems.length>0},_saveItem:function(e,t,r){if(url="PUT"===r?this._getPutUrl(e):"DELETE"===r?this._getDeleteUrl(e):this._getPostUrl(e),!url)return t.onError&&t.onError.call(n,new Error("No URL for saving content: "+postContent)),void 0;var i={url:url,method:r||"POST",contentType:"text/xml",handleAs:"xml"};"PUT"===r?(i.putData=this._getPutContent(e),saveHandler=dojo.rawXhrPut(i)):"DELETE"===r?saveHandler=dojo.xhrDelete(i):(i.postData=this._getPostContent(e),saveHandler=dojo.rawXhrPost(i));var n=t.scope||dojo.global,o=this;saveHandler.addCallback(function(){o._forgetItem(e),t.onComplete&&t.onComplete.call(n)}),saveHandler.addErrback(function(e){t.onError&&t.onError.call(n,e)})},_getPostUrl:function(){return this._url},_getPutUrl:function(){return this._url},_getDeleteUrl:function(e){if(!this._url)return this._url;var t=this._url;if(e&&this._keyAttribute){var r=this.getValue(e,this._keyAttribute);r&&(t=t+"?"+this._keyAttribute+"="+r)}return t},_getPostContent:function(e){var t=e.element,r='<?xml version="1.0"?>';return r+dojox.data.dom.innerXML(t)},_getPutContent:function(e){var t=e.element,r='<?xml version="1.0"?>';return r+dojox.data.dom.innerXML(t)},_getAttribute:function(e,t){if(this._attributeMap){var r=e+"."+t,i=this._attributeMap[r];i?t=i:(i=this._attributeMap[t],i&&(t=i))}return t},_getItem:function(e){return new dojox.data.XmlItem(e,this)},_getItemIndex:function(e,t){for(var r=0;r<e.length;r++)if(e[r].element===t)return r;return-1},_backupItem:function(e){var t=this._getRootElement(e.element);this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0||(t!=e.element&&(e=this._getItem(t)),e._backup=t.cloneNode(!0),this._modifiedItems.push(e))},_restoreItems:function(e){dojo.forEach(e,function(e){e._backup&&(e.element=e._backup,e._backup=null)},this)},_forgetItem:function(e){var t=e.element,r=this._getItemIndex(this._newItems,t);r>=0&&this._newItems.splice(r,1),r=this._getItemIndex(this._deletedItems,t),r>=0&&this._deletedItems.splice(r,1),r=this._getItemIndex(this._modifiedItems,t),r>=0&&this._modifiedItems.splice(r,1)},_getDocument:function(e){return e?e.ownerDocument:this._document?void 0:dojox.data.dom.createDocument()},_getRootElement:function(e){for(;e.parentNode;)e=e.parentNode;return e}}),dojo.declare("dojox.data.XmlItem",null,{constructor:function(e,t){this.element=e,this.store=t},toString:function(){var e="";if(this.element)for(var t=0;t<this.element.childNodes.length;t++){var r=this.element.childNodes[t];if(3===r.nodeType){e=r.nodeValue;break}}return e}}),dojo.extend(dojox.data.XmlStore,dojo.data.util.simpleFetch));