dojo._hasResource["dojo.dnd.Source"]||(dojo._hasResource["dojo.dnd.Source"]=!0,dojo.provide("dojo.dnd.Source"),dojo.require("dojo.dnd.Selector"),dojo.require("dojo.dnd.Manager"),dojo.declare("dojo.dnd.Source",dojo.dnd.Selector,{isSource:!0,horizontal:!1,copyOnly:!1,skipForm:!1,withHandles:!1,accept:["text"],constructor:function(t,e){e||(e={}),this.isSource="undefined"==typeof e.isSource?!0:e.isSource;var o=e.accept instanceof Array?e.accept:["text"];if(this.accept=null,o.length){this.accept={};for(var r=0;r<o.length;++r)this.accept[o[r]]=1}this.horizontal=e.horizontal,this.copyOnly=e.copyOnly,this.withHandles=e.withHandles,this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.before=!0,this.sourceState="",this.isSource&&dojo.addClass(this.node,"dojoDndSource"),this.targetState="",this.accept&&dojo.addClass(this.node,"dojoDndTarget"),this.horizontal&&dojo.addClass(this.node,"dojoDndHorizontal"),this.topics=[dojo.subscribe("/dnd/source/over",this,"onDndSourceOver"),dojo.subscribe("/dnd/start",this,"onDndStart"),dojo.subscribe("/dnd/drop",this,"onDndDrop"),dojo.subscribe("/dnd/cancel",this,"onDndCancel")]},checkAcceptance:function(t,e){if(this==t)return!0;for(var o=0;o<e.length;++o){for(var r=t.getItem(e[o].id).type,n=!1,i=0;i<r.length;++i)if(r[i]in this.accept){n=!0;break}if(!n)return!1}return!0},copyState:function(t){return this.copyOnly||t},destroy:function(){dojo.dnd.Source.superclass.destroy.call(this),dojo.forEach(this.topics,dojo.unsubscribe),this.targetAnchor=null},markupFactory:function(t,e){return t._skipStartup=!0,new dojo.dnd.Source(e,t)},onMouseMove:function(t){if(!this.isDragging||"Disabled"!=this.targetState){dojo.dnd.Source.superclass.onMouseMove.call(this,t);var e=dojo.dnd.manager();if(this.isDragging){var o=!1;this.current&&(this.targetBox&&this.targetAnchor==this.current||(this.targetBox={xy:dojo.coords(this.current,!0),w:this.current.offsetWidth,h:this.current.offsetHeight}),o=this.horizontal?t.pageX-this.targetBox.xy.x<this.targetBox.w/2:t.pageY-this.targetBox.xy.y<this.targetBox.h/2),(this.current!=this.targetAnchor||o!=this.before)&&(this._markTargetAnchor(o),e.canDrop(!(this.current&&e.source==this&&this.current.id in this.selection)))}else if(this.mouseDown&&this.isSource){var r=this.getSelectedNodes();r.length&&e.startDrag(this,r,this.copyState(dojo.dnd.getCopyKeyState(t)))}}},onMouseDown:function(t){!this._legalMouseDown(t)||this.skipForm&&dojo.dnd.isFormElement(t)||(this.mouseDown=!0,this.mouseButton=t.button,dojo.dnd.Source.superclass.onMouseDown.call(this,t))},onMouseUp:function(t){this.mouseDown&&(this.mouseDown=!1,dojo.dnd.Source.superclass.onMouseUp.call(this,t))},onDndSourceOver:function(t){if(this!=t)this.mouseDown=!1,this.targetAnchor&&this._unmarkTargetAnchor();else if(this.isDragging){var e=dojo.dnd.manager();e.canDrop(!("Disabled"==this.targetState||this.current&&e.source==this&&this.current.id in this.selection))}},onDndStart:function(t,e,o){this.isSource&&this._changeState("Source",this==t?o?"Copied":"Moved":"");var r=this.accept&&this.checkAcceptance(t,e);this._changeState("Target",r?"":"Disabled"),r&&this==t&&dojo.dnd.manager().overSource(this),this.isDragging=!0},onDndDrop:function(t,e,o){do{if("Over"!=this.containerState)break;var r=this._normalizedCreator;if(this!=t)this._normalizedCreator=this.creator?function(e,o){return r.call(this,t.getItem(e.id).data,o)}:o?function(e){var o=t.getItem(e.id),r=e.cloneNode(!0);return r.id=dojo.dnd.getUniqueId(),{node:r,data:o.data,type:o.type}}:function(e){var o=t.getItem(e.id);return t.delItem(e.id),{node:e,data:o.data,type:o.type}};else{if(this.current&&this.current.id in this.selection)break;if(this.creator)if(o)this._normalizedCreator=function(e,o){return r.call(this,t.getItem(e.id).data,o)};else{if(!this.current)break;this._normalizedCreator=function(e){var o=t.getItem(e.id);return{node:e,data:o.data,type:o.type}}}else if(o)this._normalizedCreator=function(e){var o=t.getItem(e.id),r=e.cloneNode(!0);return r.id=dojo.dnd.getUniqueId(),{node:r,data:o.data,type:o.type}};else{if(!this.current)break;this._normalizedCreator=function(e){var o=t.getItem(e.id);return{node:e,data:o.data,type:o.type}}}}this._removeSelection(),this!=t&&this._removeAnchor(),this==t||o||this.creator||t.selectNone(),this.insertNodes(!0,e,this.before,this.current),this!=t&&!o&&this.creator&&t.deleteSelectedNodes(),this._normalizedCreator=r}while(!1);this.onDndCancel()},onDndCancel:function(){this.targetAnchor&&(this._unmarkTargetAnchor(),this.targetAnchor=null),this.before=!0,this.isDragging=!1,this.mouseDown=!1,delete this.mouseButton,this._changeState("Source",""),this._changeState("Target","")},onOverEvent:function(){dojo.dnd.Source.superclass.onOverEvent.call(this),dojo.dnd.manager().overSource(this)},onOutEvent:function(){dojo.dnd.Source.superclass.onOutEvent.call(this),dojo.dnd.manager().outSource(this)},_markTargetAnchor:function(t){(this.current!=this.targetAnchor||this.before!=t)&&(this.targetAnchor&&this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=this.current,this.targetBox=null,this.before=t,this.targetAnchor&&this._addItemClass(this.targetAnchor,this.before?"Before":"After"))},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=null,this.targetBox=null,this.before=!0)},_markDndStatus:function(t){this._changeState("Source",t?"Copied":"Moved")},_legalMouseDown:function(t){if(!this.withHandles)return!0;for(var e=t.target;e&&!dojo.hasClass(e,"dojoDndItem");e=e.parentNode)if(dojo.hasClass(e,"dojoDndHandle")){var o=t;o||(o=window.event);var r={x:o.clientX,y:o.clientY},n=!1;return dojo.query("a",e).forEach(function(t){if(!n){var e=t.getBoundingClientRect();n=e.left<=r.x&&r.x<=e.right&&e.top<=r.y&&r.y<=e.bottom}}),n?!1:!0}return!1}}),dojo.declare("dojo.dnd.Target",dojo.dnd.Source,{constructor:function(){this.isSource=!1,dojo.removeClass(this.node,"dojoDndSource")},markupFactory:function(t,e){return t._skipStartup=!0,new dojo.dnd.Target(e,t)}}));